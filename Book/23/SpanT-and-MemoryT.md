# ูุตู ุจุณุช  ู ุณูู:  ฺฉูพุงุฑฺูโุณุงุฒ ุจุง Native ู COM 

ุงู ูุตู ุชูุถุญ ูโุฏูุฏ ฺฺฏููู ุจุง ฺฉุชุงุจุฎุงููโูุง Native (ุบุฑูุฏุฑุชโุดุฏู) Dynamic-Link (DLL) ู ฺฉุงููพูููุชโูุง Component Object Model (COM) ฺฉูพุงุฑฺู ุดูุฏ. ูฺฏุฑ ุงูฺฉู ุฎูุงู ุขู ุฐฺฉุฑ ุดุฏู ุจุงุดุฏุ ุงููุงุน ุฏุงุฏูโุง ฺฉู ุฏุฑ ุงู ูุตู ุขูุฏูโุงูุฏ ุฏุฑ ูุถุง ูุงู **System** ุง **System.Runtime.InteropServices** ูุฌูุฏ ุฏุงุฑูุฏ.

---

#### ูุฑุงุฎูุงู DLLูุง Native ๐ฆ

**P/Invoke**ุ ฺฉูุชุงู ุดุฏูโ **Platform Invocation Services**ุ ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ุจู ุชูุงุจุนุ ุณุงุฎุชุงุฑูุง ู callbackโูุง ุฏุฑ DLLูุง ุบุฑูุฏุฑุชโุดุฏู (ฺฉุชุงุจุฎุงููโูุง ูุดุชุฑฺฉ ุฏุฑ Unix) ุฏุณุชุฑุณ ูพุฏุง ฺฉูุฏ.

ุจุฑุง ูุซุงูุ ุชุงุจุน `MessageBox` ฺฉู ุฏุฑ DLL ููุฏูุฒ **user32.dll** ุชุนุฑู ุดุฏู ุงุณุช ุจู ุดฺฉู ุฒุฑ ุงุณุช:

```c
int MessageBox(HWND hWnd, LPCTSTR lpText, LPCTSTR lpCaption, UINT uType);
```

ูโุชูุงูุฏ ุงู ุชุงุจุน ุฑุง ูุณุชููุงู ุจุง ุชุนุฑู ฺฉ ูุชุฏ **static** ุจุง ููุงู ูุงูุ ุงุณุชูุงุฏู ุงุฒ ฺฉููู ฺฉูุฏ `extern` ู ุงูุฒูุฏู attribute `DllImport` ูุฑุงุฎูุงู ฺฉูุฏ:

```csharp
using System;
using System.Runtime.InteropServices;

MessageBox(IntPtr.Zero, 
           "Please do not press this again.", "Attention", 0);

[DllImport("user32.dll")]
static extern int MessageBox(IntPtr hWnd, string text, string caption, int type);
```

ฺฉูุงุณโูุง `MessageBox` ุฏุฑ ูุถุง ูุงูโูุง **System.Windows** ู **System.Windows.Forms** ุฎูุฏุดุงู ูุชุฏูุง ูุดุงุจู ุบุฑูุฏุฑุชโุดุฏู ุฑุง ูุฑุงุฎูุงู ูโฺฉููุฏ.

ูููููโุง ุงุฒ `DllImport` ุจุฑุง **Ubuntu Linux**:

```csharp
Console.WriteLine($"User ID: {getuid()}");

[DllImport("libc")]
static extern uint getuid();
```

CLR ุดุงูู ฺฉ **marshaler** ุงุณุช ฺฉู ูโุฏุงูุฏ ฺฺฏููู ูพุงุฑุงูุชุฑูุง ู ููุงุฏุฑ ุจุงุฒฺฏุดุช ุจู ุงููุงุน .NET ู ุงููุงุน ุบุฑูุฏุฑุชโุดุฏู ุชุจุฏู ุดููุฏ. ุฏุฑ ูุซุงู ููุฏูุฒุ ูพุงุฑุงูุชุฑูุง `int` ูุณุชููุงู ุจู ุนุฏุฏ ุตุญุญ ฺูุงุฑ ุจุงุช ฺฉู ุชุงุจุน ุงูุชุธุงุฑ ุฏุงุฑุฏ ุชุจุฏู ูโุดููุฏ ู ูพุงุฑุงูุชุฑูุง `string` ุจู ุขุฑุงูโูุง Unicode ูพุงุงูโุงูุชู ุจุง null (UTF-16) ุชุจุฏู ูโุดููุฏ.
`IntPtr` ฺฉ struct ุงุณุช ฺฉู ุจุฑุง ูพูุดุด ฺฉ **handle** ุบุฑูุฏุฑุชโุดุฏู ุทุฑุงุญ ุดุฏูุ ุฏุฑ ูพูุชูุฑูโูุง ณฒ ุจุชุ ณฒ ุจุช ู ุฏุฑ ูพูุชูุฑูโูุง ถด ุจุชุ ถด ุจุช ุนุฑุถ ุฏุงุฑุฏ. ุชุจุฏู ูุดุงุจู ุฏุฑ Unix ูุฒ ุงูุฌุงู ูโุดูุฏ. (ุงุฒ C# 9 ุจู ุจุนุฏุ ูโุชูุงูุฏ ุงุฒ ููุน `nint` ูู ุงุณุชูุงุฏู ฺฉูุฏ ฺฉู ุจู `IntPtr` ูฺฏุงุดุช ูโุดูุฏ.)

---

#### Marshaling ุงููุงุน ู ูพุงุฑุงูุชุฑูุง โ๏ธ

##### Marshaling ุงููุงุน ุฑุงุฌ

ุฏุฑ ุณูุช ุบุฑูุฏุฑุชโุดุฏูุ ููฺฉู ุงุณุช ุจุฑุง ููุงุด ฺฉ ููุน ุฏุงุฏู ุจุด ุงุฒ ฺฉ ุฑูุด ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏ.
ุจุฑุง ูุซุงูุ ฺฉ ุฑุดุชู (`string`) ูโุชูุงูุฏ ุดุงูู ฺฉุงุฑุงฺฉุชุฑูุง ุชฺฉโุจุงุช ANSI ุง ฺฉุงุฑุงฺฉุชุฑูุง Unicode UTF-16 ุจุงุดุฏ ู ุทูู ุขู ูโุชูุงูุฏ ุจุง ูพุดโููุฏ ูุดุฎุต ุดูุฏุ ุง null-terminated ุจุงุดุฏุ ุง ุทูู ุซุงุจุช ุฏุงุดุชู ุจุงุดุฏ.

ุจุง ุงุณุชูุงุฏู ุงุฒ attribute `MarshalAs` ูโุชูุงูุฏ ุจู marshaler CLR ูุดุฎุต ฺฉูุฏ ฺฉุฏุงู ุญุงูุช ุงุณุชูุงุฏู ุดูุฏ ุชุง ุชุจุฏู ุตุญุญ ุงูุฌุงู ฺฏุฑุฏ. ูุซุงู:

```csharp
[DllImport("...")]
static extern int Foo([MarshalAs(UnmanagedType.LPStr)] string s);
```

enum `UnmanagedType` ุดุงูู ุชูุงู ุงููุงุน Win32 ู COM ุงุณุช ฺฉู marshaler ุขูโูุง ุฑุง ูโุดูุงุณุฏ. ุฏุฑ ุงู ูุซุงูุ marshaler ุจู ุชุฑุฌูู ุจู `LPStr` ุฏุณุชูุฑ ุฏุงุฏู ุดุฏุ ฺฉู ฺฉ ุฑุดุชู ุชฺฉโุจุงุช ANSI ูพุงุงูโุงูุชู ุจุง null ุงุณุช.

ุฏุฑ ุณูุช .NET ูุฒ ุดูุง ูโุชูุงูุฏ ููุน ุฏุงุฏูโุง ฺฉู ุงุณุชูุงุฏู ูโฺฉูุฏ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ. **Handles** ุบุฑูุฏุฑุชโุดุฏูุ ุจุฑุง ูุซุงูุ ูโุชูุงููุฏ ุจู `IntPtr`ุ `int`ุ `uint`ุ `long` ุง `ulong` ูฺฏุงุดุช ุดููุฏ.

ุจุดุชุฑ handles ุบุฑูุฏุฑุชโุดุฏู ฺฉ ุขุฏุฑุณ ุง pointer ุฑุง ุฏุฑ ุจุฑ ุฏุงุฑูุฏ ู ุจูุงุจุฑุงู ุจุฑุง ุณุงุฒฺฏุงุฑ ุจุง ุณุณุชูโุนุงููโูุง ณฒ ู ถด ุจุช ุจุงุฏ ุจู `IntPtr` ูฺฏุงุดุช ุดููุฏ. ฺฉ ูุซุงู ูุนูููุ `HWND` ุงุณุช.

ุงุบูุจ ุฏุฑ ุชูุงุจุน Win32 ู POSIXุ ุจุง ูพุงุฑุงูุชุฑูุง ุนุฏุฏ ุตุญุญ ููุงุฌู ูโุดูุฏ ฺฉู ูุฌููุนูโุง ุงุฒ **constants** ุฑุง ูโูพุฐุฑูุฏุ ฺฉู ุฏุฑ ูุงู ูุฏุฑ C++ ูุงููุฏ `WinUser.h` ุชุนุฑู ุดุฏูโุงูุฏ. ุจู ุฌุง ุชุนุฑู ุขูโูุง ุจู ุนููุงู constants ุณุงุฏู ุฏุฑ C#ุ ูโุชูุงูุฏ ุขูโูุง ุฑุง ุฏุฑ ฺฉ **enum** ุชุนุฑู ฺฉูุฏ. ุงุณุชูุงุฏู ุงุฒ enum ุจุงุนุซ ุชูุฒุชุฑ ุดุฏู ฺฉุฏ ู ุงูุฒุงุด ุงูู ููุน ูโุดูุฏ. ูููููโุง ุฏุฑ ุจุฎุด ยซShared Memoryยป ุฏุฑ ุตูุญู นนต ุงุฑุงุฆู ุดุฏู ุงุณุช.

---

ููฺฏุงู ูุตุจ **Microsoft Visual Studio**ุ ุญุชูุงู ูุงูโูุง ูุฏุฑ C++ ุฑุง ูุตุจ ฺฉูุฏโุญุช ุงฺฏุฑ ูฺ ููุฑุฏ ุฏฺฏุฑ ุงุฒ ุฏุณุชู C++ ุงูุชุฎุงุจ ูฺฉุฑุฏู ุจุงุดุฏ. ุงูุฌุง ุฌุง ุงุณุช ฺฉู ุชูุงู constants ุจูู Win32 ุชุนุฑู ุดุฏูโุงูุฏ. ุณูพุณ ูโุชูุงูุฏ ููู ูุงูโูุง ูุฏุฑ ุฑุง ุจุง ุฌุณุชุฌู `*.h` ุฏุฑ ุฏุงุฑฺฉุชูุฑ ุจุฑูุงูู Visual Studio ูพุฏุง ฺฉูุฏ.

ุฏุฑ Unixุ ุงุณุชุงูุฏุงุฑุฏ POSIX ูุงูโูุง constants ุฑุง ุชุนุฑู ูโฺฉูุฏุ ุงูุง ูพุงุฏูโุณุงุฒโูุง ูุฑุฏ ุณุณุชูโูุง Unix ุณุงุฒฺฏุงุฑ ุจุง POSIX ููฺฉู ุงุณุช ููุงุฏุฑ ุนุฏุฏ ูุชูุงูุช ุจุฑุง ุงู constants ุงุฎุชุตุงุต ุฏููุฏ. ุจุงุฏ ุงุฒ ููุฏุงุฑ ุนุฏุฏ ุตุญุญ ุจุฑุง ุณุณุชูโุนุงูู ุฎูุฏ ุงุณุชูุงุฏู ฺฉูุฏ. ููฺููุ POSIX ฺฉ ุงุณุชุงูุฏุงุฑุฏ ุจุฑุง structูุง ุงุณุชูุงุฏูโุดุฏู ุฏุฑ ูุฑุงุฎูุงู interop ุชุนุฑู ูโฺฉูุฏ. ุชุฑุชุจ ููุฏูุง ุฏุฑ struct ุชูุณุท ุงุณุชุงูุฏุงุฑุฏ ุซุงุจุช ูุดุฏู ู ููฺฉู ุงุณุช ูพุงุฏูโุณุงุฒ Unix ููุฏูุง ุงุถุงู ุงุถุงูู ฺฉูุฏ. ูุงูโูุง ูุฏุฑ C++ ฺฉู ุชูุงุจุน ู ุงููุงุน ุฑุง ุชุนุฑู ูโฺฉููุฏ ูุนูููุงู ุฏุฑ `/usr/include` ุง `/usr/local/include` ูุตุจ ูโุดููุฏ.

---

ุฏุฑุงูุช ุฑุดุชูโูุง ุงุฒ ฺฉุฏ ุบุฑูุฏุฑุชโุดุฏู ุจู .NET ูุงุฒููุฏ ูุฏุฑุช ุญุงูุธู ุงุณุช. marshaler ุจู ุทูุฑ ุฎูุฏฺฉุงุฑ ุงู ฺฉุงุฑ ุฑุง ุงูุฌุงู ูโุฏูุฏ ุงฺฏุฑ ูุชุฏ ุฎุงุฑุฌ ุฑุง ุจุง `StringBuilder` ุจู ุฌุง `string` ุงุนูุงู ฺฉูุฏุ ูุงููุฏ:

```csharp
StringBuilder s = new StringBuilder(256);
GetWindowsDirectory(s, 256);
Console.WriteLine(s);

[DllImport("kernel32.dll")]
static extern int GetWindowsDirectory(StringBuilder sb, int maxChars);
```

ุฏุฑ Unix ูุฒ ูุดุงุจู ุนูู ูโฺฉูุฏ. ูุซุงู ุฒุฑ ุชุงุจุน `getcwd` ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏ ุชุง ูุณุฑ ุฌุงุฑ ุฑุง ุจุงุฒฺฏุฑุฏุงูุฏ:

```csharp
var sb = new StringBuilder(256);
Console.WriteLine(getcwd(sb, sb.Capacity));

[DllImport("libc")]
static extern string getcwd(StringBuilder buf, int size);
```

ุงฺฏุฑฺู ุงุณุชูุงุฏู ุงุฒ `StringBuilder` ุฑุงุญุช ุงุณุชุ ุงูุง ฺฉู ูุงฺฉุงุฑุขูุฏ ุงุณุช ุฒุฑุง CLR ุจุงุฏ ุชุฎุตุตโูุง ุญุงูุธู ุงุถุงู ู ฺฉูพโฺฉุฑุฏูโูุง ุฑุง ุงูุฌุงู ุฏูุฏ. ุฏุฑ ููุงุท ุญุณุงุณ ุนููฺฉุฑุฏุ ูโุชูุงูุฏ ุจุง ุงุณุชูุงุฏู ุงุฒ `char[]` ุงู ุณุฑุจุงุฑ ุฑุง ฺฉุงูุด ุฏูุฏ:

```csharp
[DllImport("kernel32.dll", CharSet = CharSet.Unicode)]
static extern int GetWindowsDirectory(char[] buffer, int maxChars);
```

ุชูุฌู ฺฉูุฏ ฺฉู ุจุงุฏ `CharSet` ุฑุง ุฏุฑ attribute `DllImport` ูุดุฎุต ฺฉูุฏ. ููฺูู ูพุณ ุงุฒ ูุฑุงุฎูุงู ุชุงุจุนุ ุจุงุฏ ุฑุดุชู ุฎุฑูุฌ ุฑุง ุจู ุทูู ููุงุณุจ ุจุฑุด ุฏูุฏ. ูโุชูุงูุฏ ุงู ฺฉุงุฑ ุฑุง ุจุง ุญุฏุงูู ุชุฎุตุต ุญุงูุธู ุจุง ุงุณุชูุงุฏู ุงุฒ **array pooling** (ุตูุญู ตนน) ุงูุฌุงู ุฏูุฏ:

```csharp
string GetWindowsDirectory()
{
    var array = ArrayPool<char>.Shared.Rent(256);
    try
    {
        int length = GetWindowsDirectory(array, 256);
        return new string(array, 0, length).ToString();
    }
    finally { ArrayPool<char>.Shared.Return(array); }
}
```

(ุงูุจุชูุ ุงู ูุซุงู ุตุฑูุงู ุขููุฒุด ุงุณุช ู ุดูุง ูโุชูุงูุฏ ูุณุฑ Windows ุฑุง ุงุฒ ุทุฑู ูุชุฏ ุฏุงุฎู `Environment.GetFolderPath` ุฏุฑุงูุช ฺฉูุฏ.)

ุงฺฏุฑ ูุทูุฆู ูุณุชุฏ ฺฺฏููู ฺฉ ูุชุฏ ุฎุงุต Win32 ุง Unix ุฑุง ูุฑุงุฎูุงู ฺฉูุฏุ ูุนูููุงู ุจุง ุฌุณุชุฌู ูุงู ุชุงุจุน ู `DllImport` ุฏุฑ ุงูุชุฑูุชุ ูููููโุง ูพุฏุง ุฎูุงูุฏ ฺฉุฑุฏ. ุจุฑุง ููุฏูุฒุ ุณุงุช [http://www.pinvoke.net](http://www.pinvoke.net) ฺฉ ูฺฉ ุงุณุช ฺฉู ูุฏู ุขู ูุณุชูุฏุณุงุฒ ุชูุงู signatureูุง Win32 ุงุณุช.
 

