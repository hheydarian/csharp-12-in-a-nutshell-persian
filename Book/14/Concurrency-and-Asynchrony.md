# ูุตู ฺูุงุฑุฏูู: ููโุฒูุงู ู ูุงููโุฒูุงู

ุจุดุชุฑ ุจุฑูุงููโูุง ูุงุฒ ุฏุงุฑูุฏ ุจุง ุจุด ุงุฒ ฺฉ ุฑูุฏุงุฏ ฺฉู ุจูโุทูุฑ ููโุฒูุงู ุฑุฎ ูโุฏูุฏ ุณุฑูฺฉุงุฑ ุฏุงุดุชู ุจุงุดูุฏ (ููโุฒูุงู ุง **Concurrency**).
ุฏุฑ ุงู ูุตูุ ูุง ุจุง ูพุดโูุงุฒูุง ุถุฑูุฑ ุดุฑูุน ูโฺฉููุ ุนู ูุจุงู **Threading** (ุงุฌุงุฏ ู ูุฏุฑุช ุฑุดุชูโูุง) ู **Tasks** (ูุธุงู)ุ ู ุณูพุณ ุงุตูู **Asynchrony** (ูุงููโุฒูุงู) ู ุชูุงุจุน ูุงููโุฒูุงู ุฏุฑ #C ุฑุง ุจุง ุฌุฒุฆุงุช ุชูุถุญ ูโุฏูู.

ุฏุฑ **ูุตู ฒฑ** ุฏูุจุงุฑู ุจู ููุถูุน **Multithreading** (ฺูุฏโุฑุดุชูโุง) ุจุง ุฌุฒุฆุงุช ุจุดุชุฑ ุจุฑูโฺฏุฑุฏู ู ุฏุฑ **ูุตู ฒฒ** ููุถูุน ูุฑุชุจุท ุนู **Parallel Programming** (ุจุฑูุงููโููุณ ููุงุฒ) ุฑุง ูพูุดุด ูโุฏูู.

---

## ๐น ููุฏูู

ุฏุฑ ุงุฏุงูู ุฑุงุฌโุชุฑู ุณูุงุฑููุง ููโุฒูุงู ุขูุฑุฏู ุดุฏู ุงุณุช:

### ๐ฅ๏ธ ููุดุชู ฺฉ ุฑุงุจุท ฺฉุงุฑุจุฑ ูพุงุณุฎโฺฏู

ุฏุฑ ุจุฑูุงููโูุง **WPF**ุ ููุจุงู ู **Windows Forms** ุจุงุฏ ฺฉุงุฑูุง ุฒูุงูโุจุฑ ุฑุง ุจูโุตูุฑุช ููโุฒูุงู ุจุง ฺฉุฏ ฺฉู ุฑุงุจุท ฺฉุงุฑุจุฑ ุดูุง ุฑุง ุงุฌุฑุง ูโฺฉูุฏ ุงูุฌุงู ุฏูุฏ ุชุง ุฑุงุจุท ฺฉุงุฑุจุฑ ููฺูุงู ูพุงุณุฎโฺฏู ุจุงู ุจูุงูุฏ.

### ๐ ูพุฑุฏุงุฒุด ููโุฒูุงู ุฏุฑุฎูุงุณุชโูุง

ุฑู ฺฉ ุณุฑูุฑุ ุฏุฑุฎูุงุณุชโูุง ฺฉูุงูุช ูโุชูุงููุฏ ุจูโุทูุฑ ููโุฒูุงู ุจุฑุณูุฏ ู ุจูุงุจุฑุงู ุจุงุฏ ุจูโุตูุฑุช ููุงุฒ ูพุฑุฏุงุฒุด ุดููุฏ ุชุง **Scalability** (ููุงุณโูพุฐุฑ) ุญูุธ ุดูุฏ. ุงฺฏุฑ ุงุฒ **ASP.NET Core** ุง **Web API** ุงุณุชูุงุฏู ฺฉูุฏุ ุฒูุงูโุงุฌุฑุง (Runtime) ุงู ฺฉุงุฑ ุฑุง ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ุจุฑุง ุดูุง ุงูุฌุงู ูโุฏูุฏ.
ุจุงุงูโุญุงูุ ููฺูุงู ุจุงุฏ ูุณุจุช ุจู **Shared State** (ูุถุนุช ูุดุชุฑฺฉ) ุขฺฏุงู ุจุงุดุฏ (ุจุฑุง ูููููุ ุงุซุฑ ุงุณุชูุงุฏู ุงุฒ **Static Variables** ุจุฑุง ฺฉุดโฺฉุฑุฏู).

### โก ุจุฑูุงููโููุณ ููุงุฒ

ฺฉุฏ ฺฉู ูุญุงุณุจุงุช ุณูฺฏู ุงูุฌุงู ูโุฏูุฏ ูโุชูุงูุฏ ุฑู ุฑุงุงููโูุง ฺูุฏโูุณุชูโุง ุง ฺูุฏโูพุฑุฏุงุฒูุฏูโุง ุณุฑุนโุชุฑ ุงุฌุฑุง ุดูุฏุ ุงฺฏุฑ ุญุฌู ฺฉุงุฑ ูุงู ูุณุชูโูุง ุชูุณู ุดูุฏ. (ูุตู ฒฒ ุจูโุทูุฑ ฺฉุงูู ุจู ุงู ููุถูุน ุงุฎุชุตุงุต ุฏุงุฑุฏ.)

### ๐ฎ ุงุฌุฑุง ุญุฏุณ (Speculative Execution)

ุฑู ูุงุดูโูุง ฺูุฏโูุณุชูโุงุ ฺฏุงู ูโุชูุงู ุจุง ูพุดโุจู ฺฉุงุฑ ฺฉู ููฺฉู ุงุณุช ูุงุฒ ุจู ุงูุฌุงู ุขู ุจุงุดุฏ ู ุงูุฌุงู ุฏุงุฏู ุขู ุงุฒ ูุจูุ ุนููฺฉุฑุฏ ุฑุง ุจูุจูุฏ ุฏุงุฏ.
ุจุฑูุงูู **LINQPad** ุงุฒ ุงู ุชฺฉูฺฉ ุจุฑุง ุณุฑุนุชโุจุฎุดุฏู ุจู ุงุฌุงุฏ ฺฉูุฆุฑโูุง ุฌุฏุฏ ุงุณุชูุงุฏู ูโฺฉูุฏ.
ููุน ุฏฺฏุฑ ุงุฒ ุงู ุฑูุด ุงู ุงุณุช ฺฉู ฺูุฏ ุงูฺฏูุฑุชู ูุฎุชูู ุฑุง ุจูโุทูุฑ ููุงุฒ ุงุฌุฑุง ฺฉูุฏ ฺฉู ููฺฏ ฺฉ ูุธูู ูุดุงุจู ุฑุง ุญู ูโฺฉููุฏ. ูุฑฺฉุฏุงู ุฒูุฏุชุฑ ุชูุงู ุดูุฏ ยซุจุฑูุฏูยป ุฎูุงูุฏ ุจูุฏ. ุงู ุฑูุด ุฒูุงู ูุคุซุฑ ุงุณุช ฺฉู ุงุฒ ูุจู ูุฏุงูุฏ ฺฉุฏุงู ุงูฺฏูุฑุชู ุณุฑุนโุชุฑ ุนูู ุฎูุงูุฏ ฺฉุฑุฏ.

---

## ๐งต ูฺฉุงูุฒู ุนููู ููโุฒูุงู: Multithreading

ูฺฉุงูุฒู ุนูููโุง ฺฉู ุจู ฺฉ ุจุฑูุงูู ุงุฌุงุฒู ูโุฏูุฏ ุจูโุทูุฑ ููโุฒูุงู ฺฉุฏ ุฑุง ุงุฌุฑุง ฺฉูุฏุ **Multithreading** ูุงู ุฏุงุฑุฏ.
Multithreading ูู ุชูุณุท **CLR** ู ูู ุชูุณุท **ุณุณุชูโุนุงูู** ูพุดุชุจุงู ูโุดูุฏ ู ฺฉ ููููู ุจูุงุฏู ุฏุฑ ููโุฒูุงู ุงุณุช.
ุจูุงุจุฑุงู ุฏุฑฺฉ ูุจุงู **Threading**ุ ู ุจูโูฺู ุชุฃุซุฑ ุฑุดุชูโูุง ุจุฑ **Shared State** (ูุถุนุช ูุดุชุฑฺฉ)ุ ุถุฑูุฑ ุงุณุช.

---

## ๐งฉ Threading

ฺฉ **Thread** ุง ยซุฑุดุชูยปุ ฺฉ ูุณุฑ ุงุฌุฑุง ูุณุชูู ุงุณุช ฺฉู ูโุชูุงูุฏ ุฌุฏุง ุงุฒ ุณุงุฑ ูุณุฑูุง ูพุด ุจุฑูุฏ.

ูุฑ ุฑุดุชู ุฏุฑูู ฺฉ **Process** (ูุฑุงูุฏ) ุณุณุชูโุนุงูู ุงุฌุฑุง ูโุดูุฏ ฺฉู ูุญุท ุงุฒููู ุฑุง ุจุฑุง ุงุฌุฑุง ฺฉ ุจุฑูุงูู ูุฑุงูู ูโฺฉูุฏ.

* ุฏุฑ ฺฉ ุจุฑูุงูู **ุชฺฉโุฑุดุชูโุง** (Single-Threaded)ุ ุชููุง ฺฉ ุฑุดุชู ุฏุฑ ูุญุท ุงุฒููู ูพุฑุฏุงุฒุด ุงุฌุฑุง ูโุดูุฏ ู ุจูุงุจุฑุงู ุขู ุฑุดุชู ุฏุณุชุฑุณ ุงูุญุตุงุฑ ุจู ุขู ุฏุงุฑุฏ.
* ุฏุฑ ฺฉ ุจุฑูุงูู **ฺูุฏโุฑุดุชูโุง** (Multi-Threaded)ุ ฺูุฏ ุฑุดุชู ุฏุฑ ฺฉ ูุฑุงูุฏ ูุงุญุฏ ุงุฌุฑุง ูโุดููุฏ ู ฺฉ ูุญุท ุงุฌุฑุง ูุดุชุฑฺฉ (ุจูโูฺู ุญุงูุธู) ุฑุง ุจุง ูู ุจู ุงุดุชุฑุงฺฉ ูโฺฏุฐุงุฑูุฏ.

ุงู ููุถูุน ุฏูู ุงุตู ููุฏ ุจูุฏู Multithreading ุงุณุช:
ุจุฑุง ูููููุ ฺฉ ุฑุดุชู ูโุชูุงูุฏ ุฏุฑ ูพุณโุฒููู ุฏุงุฏูโูุง ุฑุง ูุงฺฉุด ฺฉูุฏุ ุฏุฑุญุงูโฺฉู ุฑุดุชู ุฏฺฏุฑ ููุงู ุฏุงุฏูโูุง ุฑุง ุจูโูุญุถ ุฑุณุฏู ููุงุด ุฏูุฏ. ุงู ุฏุงุฏูโูุง ุจูโุนููุงู **Shared State** ุดูุงุฎุชู ูโุดููุฏ.

---

## ๐๏ธ ุงุฌุงุฏ ฺฉ Thread

ฺฉ ุจุฑูุงูู ฺฉูุงูุช (**Console**ุ **WPF**ุ **UWP** ุง **Windows Forms**) ุฏุฑ ฺฉ ุฑุดุชู ูููุฑุฏ ฺฉู ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ุชูุณุท ุณุณุชูโุนุงูู ุณุงุฎุชู ูโุดูุฏ (ุฑุดุชูโ ุงุตู ุง **Main Thread**) ุดุฑูุน ุจู ฺฉุงุฑ ูโฺฉูุฏ.
ุงู ุจุฑูุงูู ุชุง ุฒูุงู ฺฉู ุดูุง ฺฉุงุฑ ุฎูุงู ุขู ุงูุฌุงู ูุฏูุฏ (ุนู ุฑุดุชูโูุง ุจุดุชุฑ ุจุณุงุฒุฏุ ฺู ุจูโุทูุฑ ูุณุชูู ู ฺู ุบุฑูุณุชูู) ุจูโุตูุฑุช ุชฺฉโุฑุดุชูโุง ุจุงู ูโูุงูุฏ.ยน

ุจุฑุง ุงุฌุงุฏ ู ุดุฑูุน ฺฉ ุฑุดุชู ุฌุฏุฏุ ุจุงุฏ ฺฉ ุดุก ุงุฒ ููุน **Thread** ุจุณุงุฒุฏ ู ูุชุฏ **Start** ุขู ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ.
ุณุงุฏูโุชุฑู ุณุงุฒูุฏู (Constructor) ุจุฑุง Threadุ ฺฉ **ThreadStart Delegate** ูโฺฏุฑุฏ: ูุชุฏ ุจุฏูู ูพุงุฑุงูุชุฑ ฺฉู ูุดุงู ูโุฏูุฏ ุงุฌุฑุง ุฑุดุชู ุงุฒ ฺฉุฌุง ุขุบุงุฒ ุดูุฏ.

### ๐ ูุซุงู:

```csharp
// ุชูุฌู: ููู ูููููโูุง ุงู ูุตู ูุฑุถ ูโฺฉููุฏ ฺฉู Namespaceูุง ุฒุฑ Import ุดุฏูโุงูุฏ:
using System;
using System.Threading;

Thread t = new Thread (WriteY);     // ุงุฌุงุฏ ู ุฑุงูโุงูุฏุงุฒ ฺฉ ุฑุดุชู ุฌุฏุฏ
t.Start();                          // ุงุฌุฑุง ูุชุฏ WriteY ุฑู ุฑุดุชู ุฌุฏุฏ

// ููโุฒูุงูุ ุฑู ุฑุดุชู ุงุตู ูู ฺฉุงุฑ ุงูุฌุงู ูโุฏูู.
for (int i = 0; i < 1000; i++) Console.Write ("x");

void WriteY()
{
    for (int i = 0; i < 1000; i++) Console.Write ("y");
}
```

---

### ๐ค ุฎุฑูุฌ ููููู:

```
xxxxxxxxxxxxxxxxyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
...
```

---

ุฑุดุชู ุงุตู ฺฉ ุฑุดุชู ุฌุฏุฏ ุจู ูุงู `t` ูโุณุงุฒุฏ ู ุฑู ุขู ูุชุฏ ุฑุง ุงุฌุฑุง ูโฺฉูุฏ ฺฉู ฺฉุงุฑุงฺฉุชุฑ `y` ุฑุง ุจูโุทูุฑ ุชฺฉุฑุงุฑ ฺุงูพ ูโฺฉูุฏ.
ุจูโุทูุฑ ููโุฒูุงูุ ุฑุดุชู ุงุตู ูุฒ ฺฉุงุฑุงฺฉุชุฑ `x` ุฑุง ุจูโุทูุฑ ุชฺฉุฑุงุฑ ฺุงูพ ูโฺฉูุฏุ ููุงูโุทูุฑ ฺฉู ุฏุฑ ุดฺฉู **ฑด-ฑ** ูุดุงู ุฏุงุฏู ุดุฏู ุงุณุช.

* ุฑู ฺฉ ุฑุงุงูู ุชฺฉโูุณุชูโุงุ ุณุณุชูโุนุงูู ุจุงุฏ ยซุจูุฑุดโูุงยป ุงุฒ ุฒูุงู (ูุนูููุงู ุญุฏูุฏ **ฒฐ ููโุซุงูู** ุฏุฑ ููุฏูุฒ) ุฑุง ุจู ูุฑ ุฑุดุชู ุงุฎุชุตุงุต ุฏูุฏ ุชุง ููโุฒูุงู ุดุจูโุณุงุฒ ุดูุฏ. ูุชุฌู ุงู ฺฉุงุฑุ ุจูุงฺฉโูุง ุชฺฉุฑุงุฑ ุงุฒ `x` ู `y` ุงุณุช.
* ุฑู ฺฉ ูุงุดู ฺูุฏโูุณุชูโุง ุง ฺูุฏโูพุฑุฏุงุฒูุฏูโุงุ ุฏู ุฑุดุชู ูโุชูุงููุฏ ูุงูุนุงู ุจูโุทูุฑ ููุงุฒ ุงุฌุฑุง ุดููุฏ (ุจุง ุงู ุดุฑุท ฺฉู ุฏฺฏุฑ ูพุฑุฏุงุฒูโูุง ูุนุงู ุฑู ุฑุงุงูู ูู ุฏุฑ ุฑูุงุจุช ุจุงุดูุฏ).
  ุจุงุงูโุญุงู ุฏุฑ ุงู ูุซุงู ููฺูุงู ุจูุงฺฉโูุง ุชฺฉุฑุงุฑ ุงุฒ `x` ู `y` ูุดุงูุฏู ูโฺฉูุฏุ ุฒุฑุง ุฌุฒุฆุงุช ุธุฑู ุฏุฑ ูฺฉุงูุฒู ูุฌูุฏ ุฏุงุฑุฏ ฺฉู **Console** ุฏุฑุฎูุงุณุชโูุง ููโุฒูุงู ุฑุง ูุฏุฑุช ูโฺฉูุฏ.

<div align="center">
    
![Conventions-UsedThis-Book](../../assets/image/14/Table-14-1.jpeg) 
</div>

## ๐ ูพุดโุงูุชุงุฒุฏู (Preemption)

ููุช ุงุฌุฑุง ฺฉ **Thread** ุจุง ุงุฌุฑุง ฺฉุฏ ุฑู ฺฉ **Thread** ุฏฺฏุฑ ุฏุฑ ูู ุขูุฎุชู ูโุดูุฏุ ฺฏูุชู ูโุดูุฏ ฺฉู ุขู Thread **Preempted** (ูพุดโุงูุชุงุฒ ุฏุงุฏู ุดุฏู) ุงุณุช. ุงู ุงุตุทูุงุญ ุงุบูุจ ุฒูุงู ุธุงูุฑ ูโุดูุฏ ฺฉู ุจุฎูุงูู ุชูุถุญ ุฏูู ฺุฑุง ฺุฒ ุจูโุฏุฑุณุช ฺฉุงุฑ ูฺฉุฑุฏู ุงุณุช!

---

## ๐ข ูุถุนุช ุฒูุฏู ุจูุฏู (IsAlive)

ูพุณ ุงุฒ ุดุฑูุน ุดุฏูุ ูฺฺฏ (**Property**) `IsAlive` ุฏุฑ ฺฉ Thread ููุฏุงุฑ **true** ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ ุชุง ุฒูุงู ฺฉู ุขู Thread ูพุงุงู ุงุจุฏ.
ฺฉ Thread ุฒูุงู ูพุงุงู ูโุงุจุฏ ฺฉู **Delegate**ุง ฺฉู ุจู ุณุงุฒูุฏูโ (Constructor) ุขู ุฏุงุฏู ุดุฏูุ ุงุฌุฑุง ุฎูุฏ ุฑุง ุชูุงู ฺฉูุฏ. ูพุณ ุงุฒ ูพุงุงู ุงูุชูุ ฺฉ Thread ุฑุง ููโุชูุงู ุฏูุจุงุฑู ุฑุงูโุงูุฏุงุฒ ฺฉุฑุฏ.

---

## ๐ ูุงูโฺฏุฐุงุฑ Threadูุง

ูุฑ Thread ฺฉ ูฺฺฏ ุจู ูุงู **Name** ุฏุงุฑุฏ ฺฉู ูโุชูุงูุฏ ุขู ุฑุง ุจุฑุง ุงูุฏุงู **Debugging** ุชูุธู ฺฉูุฏ.
ุงู ูฺฺฏ ุฏุฑ **Visual Studio** ุจุณุงุฑ ููุฏ ุงุณุชุ ุฒุฑุง ูุงู Thread ุฏุฑ **Threads Window** ู ููุงุฑ ุงุจุฒุงุฑ **Debug Location** ููุงุด ุฏุงุฏู ูโุดูุฏ.
ุดูุง ุชููุง ฺฉโุจุงุฑ ูโุชูุงูุฏ ูุงู ฺฉ Thread ุฑุง ุชูุธู ฺฉูุฏุ ูุฑ ุชูุงุด ุฏฺฏุฑ ุจุฑุง ุชุบุฑ ูุงูุ ฺฉ **Exception** ุงุฌุงุฏ ุฎูุงูุฏ ฺฉุฑุฏ.

---

## ๐ ุฏุณุชุฑุณ ุจู Thread ูุนู

ูฺฺฏ ุงุณุชุงุชฺฉ `Thread.CurrentThread` ุฑุดุชูโุง ุฑุง ฺฉู ุฏุฑ ุญุงู ุญุงุถุฑ ุฏุฑ ุญุงู ุงุฌุฑุงุณุช ุจุฑูโฺฏุฑุฏุงูุฏ:

```csharp
Console.WriteLine (Thread.CurrentThread.Name);
```

---

## โณ Join ู Sleep

### ๐ Join

ูโุชูุงูุฏ ุจุง ูุฑุงุฎูุงู ูุชุฏ **Join** ููุชุธุฑ ุจูุงูุฏ ุชุง ฺฉ Thread ุฏฺฏุฑ ูพุงุงู ุงุจุฏ:

```csharp
Thread t = new Thread (Go);
t.Start();
t.Join();
Console.WriteLine ("Thread t has ended!");

void Go() 
{ 
    for (int i = 0; i < 1000; i++) Console.Write ("y"); 
}
```

ุงู ฺฉุฏ ุงุจุชุฏุง ฑฐฐฐ ุจุงุฑ `y` ฺุงูพ ูโฺฉูุฏ ู ุจูุงูุงุตูู ูพุณ ุงุฒ ุขู ูุชู `"Thread t has ended!"` ููุงุด ุฏุงุฏู ูโุดูุฏ.

ููฺูู ูโุชูุงูุฏ ููฺฏุงู ูุฑุงุฎูุงู **Join** ฺฉ **Timeout** ูุดุฎุต ฺฉูุฏ (ุจุฑุญุณุจ ููโุซุงูู ุง ฺฉ **TimeSpan**). ุฏุฑ ุงู ุตูุฑุช ูุชุฏ ููุฏุงุฑ **true** ุจุฑูโฺฏุฑุฏุงูุฏ ุงฺฏุฑ Thread ูพุงุงู ุงูุชู ุจุงุดุฏุ ุง **false** ุงฺฏุฑ ุฒูุงู ุชูุงู ุดุฏู ุจุงุดุฏ.

---

### ๐ Sleep

ูุชุฏ **Thread.Sleep** ุงุฌุฑุง Thread ูุนู ุฑุง ุจุฑุง ูุฏุช ูุดุฎุต ูุชููู ูโฺฉูุฏ:

```csharp
Thread.Sleep (TimeSpan.FromHours (1));  // ุชููู ุจุฑุง ฑ ุณุงุนุช
Thread.Sleep (500);                     // ุชููู ุจุฑุง ตฐฐ ููโุซุงูู
```

ูุฑุงุฎูุงู `Thread.Sleep(0)` ุจูุงูุงุตูู **ุจูุฑุด ุฒูุงู** (Time Slice) ูุนู ุฑุง ุขุฒุงุฏ ฺฉุฑุฏู ู ุฏุงูุทูุจุงูู CPU ุฑุง ุฏุฑ ุงุฎุชุงุฑ ุณุงุฑ Threadูุง ูุฑุงุฑ ูโุฏูุฏ.
ูุชุฏ `Thread.Yield()` ูุฒ ููู ฺฉุงุฑ ุฑุง ุงูุฌุงู ูโุฏูุฏุ ุจุง ุงู ุชูุงูุช ฺฉู CPU ุฑุง ุชููุง ุจู Threadูุง ูุงฺฏุฐุงุฑ ูโฺฉูุฏ ฺฉู ุฑู ููุงู ูพุฑุฏุงุฒูุฏู ุฏุฑ ุญุงู ุงุฌุฑุง ูุณุชูุฏ.

* ุงุณุชูุงุฏู ุงุฒ `Sleep(0)` ุง `Yield` ฺฏุงู ุฏุฑ ฺฉุฏูุง **Production** ุจุฑุง ุจูููโุณุงุฒโูุง ูพุดุฑูุชูโ ุนููฺฉุฑุฏ ููุฏ ุงุณุช.
* ุงูโูุง ููฺูู ุงุจุฒุงุฑูุง ุนุงู **Diagnostic** (ุนุจโุงุจ) ูุณุชูุฏ: ุงฺฏุฑ ุงุถุงูู ฺฉุฑุฏู `Thread.Yield()` ุฏุฑ ูุฑุฌุง ฺฉุฏ ุดูุง ุจุงุนุซ ุฎุฑุงุจ ุดุฏู ุจุฑูุงูู ุดูุฏุ ุชูุฑุจุงู ูุทูุฆู ุจุงุดุฏ ฺฉู ฺฉ **Bug** ุฏุฑ ฺฉุฏุชุงู ูุฌูุฏ ุฏุงุฑุฏ.

---

## ๐ซ Block ุดุฏู ฺฉ Thread

ููุช ุงุฌุฑุง ฺฉ Thread ุจู ุฏูุงู ูุชููู ุดูุฏุ ฺฏูุชู ูโุดูุฏ ฺฉู ุขู Thread **Blocked** ุงุณุชุ ูุซูุงู ููฺฏุงู ุงุฌุฑุง **Sleep** ุง ููุชุธุฑ ูุงูุฏู ุจุฑุง ูพุงุงู ุงูุชู ฺฉ Thread ุฏฺฏุฑ ุจุง **Join**.

* ฺฉ Thread **Blocked** ุจูุงูุงุตูู ุจูุฑุด ุฒูุงู ูพุฑุฏุงุฒูุฏูโ ุฎูุฏ ุฑุง ุขุฒุงุฏ ูโฺฉูุฏ.
* ุงุฒ ุขู ูุญุธู ุจู ุจุนุฏุ ูฺ ุฒูุงู ุงุฒ CPU ูุตุฑู ููโฺฉูุฏ ุชุง ุฒูุงู ฺฉู ุดุฑุท Block ุดุฏู ุจุฑุทุฑู ุดูุฏ.

ุจุฑุง ุจุฑุฑุณ ุงูฺฉู ุขุง ฺฉ Thread ุฏุฑ ุญุงูุช Block ุงุณุช ูโุชูุงูุฏ ุงุฒ ูฺฺฏ **ThreadState** ุงุณุชูุงุฏู ฺฉูุฏ:

```csharp
bool blocked = (someThread.ThreadState & ThreadState.WaitSleepJoin) != 0;
```

---

## โ๏ธ ThreadState

ูฺฺฏ **ThreadState** ฺฉ **Flags Enum** ุงุณุช ฺฉู ุณู ยซูุงูยป ุฏุงุฏู ุฑุง ุจูโุตูุฑุช **Bitwise** ุชุฑฺฉุจ ูโฺฉูุฏ.
ุจุงุงูโุญุงู ุจุดุชุฑ ููุงุฏุฑ ุขู ุฒุงุฆุฏุ ุจูุงุงุณุชูุงุฏู ุง ููุณูุฎ ุดุฏูโุงูุฏ.

ุฑูุด ุชูุณุนูโุงูุชูโ ุฒุฑ ฺฉ ููุฏุงุฑ ThreadState ุฑุง ุจู ฺฉ ุงุฒ ฺูุงุฑ ููุฏุงุฑ ููุฏ ุณุงุฏูโุณุงุฒ ูโฺฉูุฏ:

* **Unstarted**
* **Running**
* **WaitSleepJoin**
* **Stopped**

```csharp
public static ThreadState Simplify (this ThreadState ts)
{
    return ts & (ThreadState.Unstarted |
                 ThreadState.WaitSleepJoin |
                 ThreadState.Stopped);
}
```

๐ ูฺฺฏ ThreadState ุจุฑุง ููุงุตุฏ **Diagnostic** ููุฏ ุงุณุชุ ุงูุง ุจุฑุง **Synchronization** ููุงุณุจ ูุณุชุ ุฒุฑุง ูุถุนุช ฺฉ Thread ูโุชูุงูุฏ ุจู ุจุฑุฑุณ ููุฏุงุฑ ThreadState ู ุนููโฺฉุฑุฏู ุจุฑ ุงุณุงุณ ุขู ุชุบุฑ ฺฉูุฏ.

ููฺฏุงูโฺฉู ฺฉ Thread **Block** ุง **Unblock** ูโุดูุฏุ ุณุณุชูโุนุงูู ฺฉ **Context Switch** ุงูุฌุงู ูโุฏูุฏ. ุงู ุนูู ูุฒููโ ุงูุฏฺฉ ุฏุงุฑุฏ (ูุนูููุงู ฺฉ ุง ุฏู ูฺฉุฑูุซุงูู).

---

## โ๏ธ I/O-bound ุฏุฑ ููุงุจู Compute-bound

* ุนููุงุช ฺฉู ุจุดุชุฑ ุฒูุงู ุฎูุฏ ุฑุง ุฏุฑ ุงูุชุธุงุฑ ุฑุฎโุฏุงุฏู ฺุฒ ูโฺฏุฐุฑุงูุฏุ **I/O-bound** ูุงูุฏู ูโุดูุฏ.
  ููููู: **ุฏุงูููุฏ ฺฉ ุตูุญู ูุจ** ุง ูุฑุงุฎูุงู `Console.ReadLine`.
  (ุนููุงุช I/O-bound ูุนูููุงู ุดุงูู ูุฑูุฏ ุง ุฎุฑูุฌ ูุณุชูุฏุ ุงูุง ุงู ฺฉ ุงูุฒุงู ูุทุน ูุณุช: `Thread.Sleep` ูู I/O-bound ูุญุณูุจ ูโุดูุฏ.)

* ุฏุฑ ููุงุจูุ ุนููุงุช ฺฉู ุจุดุชุฑ ุฒูุงู ุฎูุฏ ุฑุง ุตุฑู ุงูุฌุงู ฺฉุงุฑูุง ุณูฺฏู CPU ูโฺฉูุฏุ **Compute-bound** ูุงู ุฏุงุฑุฏ.

---

## ๐ Blocking ุฏุฑ ููุงุจู Spinning

ฺฉ ุนููุงุช I/O-bound ูโุชูุงูุฏ ุจู ุฏู ุตูุฑุช ุนูู ฺฉูุฏ:

1. **ุงูุชุธุงุฑ ููฺฏุงู (Synchronous)** ุฑู Thread ูุนู ุชุง ูพุงุงู ุนููุงุช (ูุซุงู: `Console.ReadLine`ุ `Thread.Sleep` ุง `Thread.Join`).
2. **ุนูู ูุงููฺฏุงู (Asynchronous)** ฺฉู ุจุง ูพุงุงู ุนููุงุช ุฏุฑ ุขูุฏูุ ฺฉ **Callback** ุงุฌุฑุง ูโฺฉูุฏ (ุจุดุชุฑ ุฏุฑ ุงุฏุงูู ุงู ูุตู ุชูุถุญ ุฏุงุฏู ูโุดูุฏ).

---

### ๐ Blocking ุจุง ุญููู Sleep

ุนููุงุชโูุง I/O-bound ฺฉู ุจูโุตูุฑุช ููฺฏุงู ููุชุธุฑ ูโูุงููุฏ ุจุดุชุฑ ุฒูุงู ุฎูุฏ ุฑุง ุฏุฑ ุญุงูุช Block ุณูพุฑ ูโฺฉููุฏ.
ฺฏุงู ุงู ุงูุชุธุงุฑ ุจู ุดฺฉู ฺฉ ุญูููโ Sleep ูพุงุฏูโุณุงุฒ ูโุดูุฏ:

```csharp
while (DateTime.Now < nextStartTime)
    Thread.Sleep (100);
```

---

### ๐ Spinning (ฺุฑุฎุด ูุฏุงูู)

ฺฏุฒููโ ุฏฺฏุฑ ุงู ุงุณุช ฺฉู ฺฉ Thread ุจูโุทูุฑ ูุฏุงูู ุจฺุฑุฎุฏ:

```csharp
while (DateTime.Now < nextStartTime);
```

ุงู ฺฉุงุฑ ุจูโุดุฏุช ููุช CPU ุฑุง ุชูู ูโฺฉูุฏ. ุงุฒ ุฏุฏ **CLR** ู ุณุณุชูโุนุงููุ Thread ุฏุฑ ุญุงู ุงูุฌุงู ฺฉ ูุญุงุณุจู ููู ุงุณุชุ ุจูุงุจุฑุงู ููุงุจุน ุจู ุขู ุงุฎุชุตุงุต ุฏุงุฏู ูโุดูุฏ. ุฏุฑ ุนููุ ูุง ฺฉ ุนููุงุช I/O-bound ุฑุง ุจู ฺฉ ุนููุงุช **Compute-bound** ุชุจุฏู ฺฉุฑุฏูโุงู.

---

## โจ ูฺฉุงุช ุธุฑู ุฏุฑุจุงุฑู Spinning ุฏุฑ ุจุฑุงุจุฑ Blocking

ฑ. **Spinning ฺฉูุชุงูโูุฏุช** ฺฏุงู ูโุชูุงูุฏ ูุคุซุฑ ุจุงุดุฏุ ุฒูุงู ฺฉู ุงูุชุธุงุฑ ุฏุงุฑุฏ ุดุฑุท ุจูโุฒูุฏ (ูุซูุงู ุฏุฑ ฺูุฏ ูฺฉุฑูุซุงูู) ุจุฑูุฑุงุฑ ุดูุฏ. ุงู ฺฉุงุฑ ุงุฒ ุณุฑุจุงุฑ ู ุชุฃุฎุฑ **Context Switch** ุฌููฺฏุฑ ูโฺฉูุฏ.
๐ ุจุฑุง ุงู ููุธูุฑุ .NET ูุชุฏูุง ู ฺฉูุงุณโูุง ุฎุงุต ูุซู **SpinLock** ู **SpinWait** ุฑุง ุงุฑุงุฆู ูโุฏูุฏ.

ฒ. **Blocking ูู ุจโูุฒูู ูุณุช**. ูุฑ Thread ุญุฏูุฏ **ฑ ูฺฏุงุจุงุช ุญุงูุธู** ุฑุง ุจุฑุง ุชูุงู ูุฏุช ุนูุฑุด ุงุดุบุงู ูโฺฉูุฏ ู ุจุฑุง **CLR** ู ุณุณุชูโุนุงูู ุจุงุฑ ูุฏุฑุช ูุฏุงูู ุงุฌุงุฏ ูโฺฉูุฏ.
ุจู ููู ุฏููุ Blocking ุฏุฑ ุจุฑูุงููโูุง ุจุณุงุฑ I/O-bound ฺฉู ุจุงุฏ ุตุฏูุง ุง ูุฒุงุฑุงู ุนููุงุช ููโุฒูุงู ุฑุง ูุฏุฑุช ฺฉููุฏ ูโุชูุงูุฏ ูุดฺฉูโุณุงุฒ ุดูุฏ.

๐ ุฏุฑ ฺูู ุดุฑุงุทุ ุจุฑูุงููโูุง ุจุงุฏ ุงุฒ ุฑูฺฉุฑุฏ **Callback-based** ุงุณุชูุงุฏู ฺฉููุฏุ ุนู ููฺฏุงู ุงูุชุธุงุฑุ Thread ุฎูุฏ ุฑุง ุจูโุทูุฑ ฺฉุงูู ุขุฒุงุฏ ฺฉููุฏ.
ุงู ุฏููุงู (ุจุฎุด ุงุฒ) ูุฏู ุงูฺฏููุง **Asynchronous** ุงุณุช ฺฉู ุฏุฑ ุงุฏุงูู ุจุฑุฑุณ ุฎูุงูู ฺฉุฑุฏ.

## ๐ ูุถุนุช ูุญู ุฏุฑ ููุงุจู ูุถุนุช ูุดุชุฑฺฉ

**CLR** ุจู ูุฑ Thread ูพุดุชูโ ุญุงูุธูโ ูุฎุตูุต ุฎูุฏุด ุฑุง ุงุฎุชุตุงุต ูโุฏูุฏุ ุจูุงุจุฑุงู ูุชุบุฑูุง ูุญู ุงุฒ ูู ุฌุฏุง ูฺฏู ุฏุงุดุชู ูโุดููุฏ.

ุฏุฑ ูุซุงู ุฒุฑุ ูุชุฏ ุจุง ฺฉ ูุชุบุฑ ูุญู ุชุนุฑู ูโฺฉูู ู ุณูพุณ ุขู ูุชุฏ ุฑุง ุจูโุทูุฑ ููโุฒูุงู ุฑู **Thread ุงุตู** ู ฺฉ **Thread ุฌุฏุฏ** ูุฑุงุฎูุงู ูโฺฉูู:

```csharp
new Thread (Go).Start();      // ูุฑุงุฎูุงู Go() ุฑู ฺฉ Thread ุฌุฏุฏ
Go();                         // ูุฑุงุฎูุงู Go() ุฑู Thread ุงุตู

void Go()
{
    // ุชุนุฑู ู ุงุณุชูุงุฏู ุงุฒ ูุชุบุฑ ูุญู - 'cycles'
    for (int cycles = 0; cycles < 5; cycles++) 
        Console.Write ('?');
}
```

ุจุฑุง ูุฑ Thread ฺฉ ูุณุฎู ุฌุฏุงฺฏุงูู ุงุฒ ูุชุบุฑ `cycles` ุฑู ูพุดุชูโ ุญุงูุธูโุงุด ุณุงุฎุชู ูโุดูุฏ. ุจูุงุจุฑุงูุ ุฎุฑูุฌ ุทุจู ุงูุชุธุงุฑ ฑฐ ุนูุงูุช ุณุคุงู ุฎูุงูุฏ ุจูุฏ.

---

## ๐ค ุงุดุชุฑุงฺฉ ุฏุงุฏู ุจู Threadูุง

Threadูุง ุฏุงุฏูโูุง ุฑุง ุฏุฑ ุตูุฑุช ุจู ุงุดุชุฑุงฺฉ ูโฺฏุฐุงุฑูุฏ ฺฉู ูุฑุฌุน (Reference) ูุดุชุฑฺฉ ุจู ฺฉ ุดุก ุง ูุชุบุฑ ุฏุงุดุชู ุจุงุดูุฏ:

```csharp
bool _done = false;
new Thread (Go).Start();
Go();

void Go()
{
    if (!_done) 
    { 
        _done = true; 
        Console.WriteLine ("Done"); 
    }
}
```

ุฏุฑ ุงู ูุซุงูุ ูุฑ ุฏู Thread ูุชุบุฑ `_done` ุฑุง ุจู ุงุดุชุฑุงฺฉ ูโฺฏุฐุงุฑูุฏุ ูพุณ ุฎุฑูุฌ `"Done"` ููุท ฺฉโุจุงุฑ ฺุงูพ ูโุดูุฏ.

---

### ๐ ุงุดุชุฑุงฺฉโฺฏุฐุงุฑ ุงุฒ ุทุฑู Lambda

ูุชุบุฑูุง ูุญู ฺฉู ุฏุฑ ฺฉ **Lambda Expression** ฺฏุฑูุชู (Capture) ูโุดููุฏ ูุฒ ูโุชูุงููุฏ ูุดุชุฑฺฉ ุจุงุดูุฏ:

```csharp
bool done = false;
ThreadStart action = () =>
{
    if (!done) 
    { 
        done = true; 
        Console.WriteLine ("Done"); 
    }
};

new Thread (action).Start();
action();
```

---

### ๐ ุงุดุชุฑุงฺฉโฺฏุฐุงุฑ ุงุฒ ุทุฑู Fieldูุง

ุจูโุทูุฑ ุฑุงุฌโุชุฑุ **Fieldูุง** ุจุฑุง ุงุดุชุฑุงฺฉ ุฏุงุฏู ูุงู Threadูุง ุงุณุชูุงุฏู ูโุดููุฏ.

```csharp
var tt = new ThreadTest();
new Thread (tt.Go).Start();
tt.Go();

class ThreadTest 
{
    bool _done;
    public void Go()
    {
        if (!_done) 
        { 
            _done = true; 
            Console.WriteLine ("Done"); 
        }
    }
}
```

---

### ๐ ุงุดุชุฑุงฺฉโฺฏุฐุงุฑ ุงุฒ ุทุฑู Static Field

ุฑุงู ุฏฺฏุฑ ุจุฑุง ุงุดุชุฑุงฺฉ ุฏุงุฏูโูุง ูุงู Threadูุง ุงุณุชูุงุฏู ุงุฒ **Static Field**ูุงุณุช:

```csharp
class ThreadTest 
{
    static bool _done;    // Static Fieldูุง ูุงู ููู Threadูุง ุฏุฑ ฺฉ Process ูุดุชุฑฺฉ ูุณุชูุฏ

    static void Main()
    {
        new Thread (Go).Start();
        Go();
    }

    static void Go()
    {
        if (!_done) 
        { 
            _done = true; 
            Console.WriteLine ("Done"); 
        }
    }
}
```

---

## โ๏ธ ูุดฺฉู Thread Safety

ูุฑ ฺูุงุฑ ูุซุงู ุจุงูุง ููููู ฺฉูุฏ ุฏฺฏุฑ ุฑุง ูุดุงู ูโุฏููุฏ: **ุงูู Threadูุง** (ุง ุจูุชุฑ ุจฺฏููุ ูุจูุฏ ุขู!).
ุฏุฑ ุญููุช ุฎุฑูุฌ **ูุงูุนู** ุงุณุช: ุงู ุงูฺฉุงู (ูุฑฺูุฏ ูุงุฏุฑ) ูุฌูุฏ ุฏุงุฑุฏ ฺฉู `"Done"` ุฏูุจุงุฑ ฺุงูพ ุดูุฏ.

ุงฺฏุฑ ุชุฑุชุจ ุฏุณุชูุฑุงุช ุฏุฑ ูุชุฏ `Go` ุฑุง ุนูุถ ฺฉููุ ุงุญุชูุงู ฺุงูพ ุฏูุจุงุฑู `"Done"` ุจูโุดุฏุช ุงูุฒุงุด ูโุงุจุฏ:

```csharp
static void Go()
{
    if (!_done) 
    { 
        Console.WriteLine ("Done"); 
        _done = true; 
    }
}
```

ูุดฺฉู ุงูุฌุงุณุช ฺฉู ฺฉ Thread ููฺฉู ุงุณุช ุฏุฑ ุญุงู ุจุฑุฑุณ ุดุฑุท `if` ุจุงุดุฏ ุฏุฑ ููุงู ูุญุธูโุง ฺฉู Thread ุฏฺฏุฑ ุฏุงุฑุฏ `WriteLine` ุฑุง ุงุฌุฑุง ูโฺฉูุฏโูุจู ุงุฒ ุขูฺฉู ูุฑุตุช ฺฉูุฏ ููุฏุงุฑ `_done` ุฑุง ุจุฑุงุจุฑ **true** ฺฉูุฏ.

ุงู ูุซุงู ฺฉ ุงุฒ ุฑุงูโูุง ูุชุนุฏุฏ ุฑุง ูุดุงู ูโุฏูุฏ ฺฉู ุฏุฑ ุขู **Shared Writable State** (ูุถุนุช ูุดุชุฑฺฉ ูุงุจูโููุดุชู) ูโุชูุงูุฏ ุฎุทุงูุง ูุชูุงูุจ ุงุฌุงุฏ ฺฉูุฏุ ููุงู ุฎุทุงูุง ฺฉู **Multithreading** ุจูโุจุฏูุงู ุจุฑุง ุขูโูุง ูุดููุฑ ุงุณุช.

---

## ๐ ูููโฺฏุฐุงุฑ ู ุงูู Threadูุง

ุจุฑุง ุญู ูุซุงู ูุจู ูโุชูุงูู ููฺฏุงู ุฎูุงูุฏู ู ููุดุชู ุฑู Field ูุดุชุฑฺฉุ ฺฉ **Exclusive Lock** ุจฺฏุฑู.
\#C ุจุฑุง ุงู ููุธูุฑ ุฏุณุชูุฑ `lock` ุฑุง ูุฑุงูู ฺฉุฑุฏู ุงุณุช:

```csharp
class ThreadSafe 
{
    static bool _done;
    static readonly object _locker = new object();

    static void Main()
    {
        new Thread (Go).Start();
        Go();
    }

    static void Go()
    {
        lock (_locker)
        {
            if (!_done) 
            { 
                Console.WriteLine ("Done"); 
                _done = true; 
            }
        }
    }
}
```

ููุช ุฏู Thread ููโุฒูุงู ุจุฑุง ฺฏุฑูุชู ฺฉ Lock (ฺฉู ูโุชูุงูุฏ ุฑู ูุฑ ุดุก ุงุฒ ููุน Reference ุจุงุดุฏุ ุฏุฑ ุงูุฌุง `_locker`) ุฑูุงุจุช ฺฉููุฏุ ฺฉ ุงุฒ ุขูโูุง ููุชุธุฑ ูโูุงูุฏ (Blocked) ุชุง Lock ุขุฒุงุฏ ุดูุฏ.
ุงู ฺฉุงุฑ ุชุถูู ูโฺฉูุฏ ฺฉู ููุท ฺฉ Thread ูโุชูุงูุฏ ููโุฒูุงู ูุงุฑุฏ ุจููฺฉ ฺฉุฏ ุดูุฏุ ู `"Done"` ููุท ฺฉโุจุงุฑ ฺุงูพ ุฎูุงูุฏ ุดุฏ.

ฺฉุฏ ฺฉู ุจู ุงู ุดฺฉู ูุญุงูุธุช ุดุฏู ุจุงุดุฏโุฏุฑ ุจุฑุงุจุฑ ุนุฏู ูุทุนุช ุฏุฑ ฺฉ ูุญุท ฺูุฏโุฑุดุชูโุงโุจู ุขู **Thread Safe** ูโฺฏููุฏ.

---

## โก ุนููุงุช ูุงุงูู ุญุช ุฏุฑ ุณุงุฏูโุชุฑู ุญุงูุงุช

ุญุช ุนูู ุณุงุฏูโ **Auto-increment** ฺฉ ูุชุบุฑ ูู Thread Safe ูุณุช:

ุนุจุงุฑุช `x++` ุฑู ูพุฑุฏุงุฒูุฏู ุจูโุตูุฑุช ฺูุฏ ุนูู ุฌุฏุงฺฏุงูู (ุฎูุงูุฏูุ ุงูุฒุงุด ู ููุดุชู) ุงุฌุฑุง ูโุดูุฏ.
ุจูุงุจุฑุงู ุงฺฏุฑ ุฏู Thread ููโุฒูุงู `x++` ุฑุง ุฎุงุฑุฌ ุงุฒ ฺฉ Lock ุงุฌุฑุง ฺฉููุฏุ ูุชุบุฑ ููฺฉู ุงุณุช ููุท ฺฉโุจุงุฑ ุงูุฒุงุด ุงุจุฏ ุจูโุฌุง ุฏูุจุงุฑ (ุง ุจุฏุชุฑุ ููุฏุงุฑ `x` ููฺฉู ุงุณุช ุฏุฑ ุดุฑุงุท ุฎุงุต ุจูโุดฺฉู ุชฺฉูโุชฺฉู ู ูุงุฏุฑุณุช ุฐุฎุฑู ุดูุฏ).

---

## ๐ซ ูุญุฏูุฏุชโูุง ูููโฺฏุฐุงุฑ

ูููโฺฏุฐุงุฑ **ฺฏูููู ููุฑูโุง** ุจุฑุง ุญู ููู ูุดฺฉูุงุช Thread Safety ูุณุช:

* ููฺฉู ุงุณุช ูุฑุงููุด ฺฉูุฏ ฺฉู ุฏุฑ ุญู ุฏุณุชุฑุณ ุจู ฺฉ Field ุงุฒ Lock ุงุณุชูุงุฏู ฺฉูุฏ.
* ูููโฺฏุฐุงุฑ ุฎูุฏุด ูโุชูุงูุฏ ูุดฺฉูุงุช ูุงููุฏ **Deadlock** ุงุฌุงุฏ ฺฉูุฏ.

ฺฉ ููููู ุฎูุจ ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ูููโฺฏุฐุงุฑุ ุฏุณุชุฑุณ ุจู ฺฉ **Cache ุฏุฑ ุญุงูุธู** ุงุณุช ฺฉู ุจุฑุง ูฺฏูุฏุงุฑ ุงุดุง ูพุงฺฏุงู ุฏุงุฏู ุฏุฑ ฺฉ ุจุฑูุงููโ **ASP.NET** ุงุณุชูุงุฏู ูโุดูุฏ.
ุงู ููุน ุจุฑูุงูู ุณุงุฏู ุงุณุช ู ุจูโุฏุฑุณุช ฺฉุงุฑ ูโฺฉูุฏ ู ูฺ ุฎุทุฑ ุจุฑุง Deadlock ูุฌูุฏ ูุฏุงุฑุฏ.
ูููููโุง ุงุฒ ุงู ููุถูุน ุฑุง ุฏุฑ ุจุฎุด **"Thread Safety in Application Servers"** (ุตูุญู นฐฑ) ุฎูุงูู ุฏุฏ.

## ๐ค ุงุฑุณุงู ุฏุงุฏู ุจู ฺฉ Thread

ฺฏุงู ูุงุฒู ุงุณุช ููฺฏุงู ุดุฑูุน ฺฉ **Thread**ุ ุขุฑฺฏููุงูโูุง ุจู ูุชุฏ ูุฑูุฏ ุขู ุงุฑุณุงู ฺฉูุฏ.
ุณุงุฏูโุชุฑู ุฑุงู ุจุฑุง ุงู ฺฉุงุฑ ุงุณุชูุงุฏู ุงุฒ **Lambda Expression** ุงุณุช ฺฉู ูุชุฏ ุฑุง ุจุง ุขุฑฺฏููุงูโูุง ููุฑุฏ ูุธุฑ ูุฑุงุฎูุงู ูโฺฉูุฏ:

```csharp
Thread t = new Thread ( () => Print ("Hello from t!") );
t.Start();

void Print (string message) => Console.WriteLine (message);
```

ุจุง ุงู ุฑูุดุ ูโุชูุงูุฏ ูุฑ ุชุนุฏุงุฏ ุขุฑฺฏููุงู ุฑุง ุจู ูุชุฏ ุงุฑุณุงู ฺฉูุฏ.
ุญุช ูโุชูุงูุฏ ฺฉู ูพุงุฏูโุณุงุฒ ุฑุง ุฏุฑ ฺฉ **Lambda ฺูุฏโุฏุณุชูุฑูโุง** ูุฑุงุฑ ุฏูุฏ:

```csharp
new Thread (() =>
{
    Console.WriteLine ("I'm running on another thread!");
    Console.WriteLine ("This is so easy!");
}).Start();
```

---

### ๐ ุฑูุด ุฏฺฏุฑ: ุงุณุชูุงุฏู ุงุฒ `Thread.Start`

ุฑูุด ุฌุงฺฏุฒู (ุงูุง ฺฉูุชุฑ ุงูุนุทุงูโูพุฐุฑ) ุงู ุงุณุช ฺฉู ุขุฑฺฏููุงู ุฑุง ุจู ูุชุฏ `Start` ุงุฑุณุงู ฺฉูู:

```csharp
Thread t = new Thread (Print);
t.Start ("Hello from t!");

void Print (object messageObj)
{
    string message = (string) messageObj;   // ูุงุฒ ุจู Cast ุฏุงุฑู
    Console.WriteLine (message);
}
```

ุงู ุฑูุด ฺฉุงุฑ ูโฺฉูุฏ ฺูู ุณุงุฒูุฏูโ **Thread** ุจุฑุง ุฏู ููุน Delegate **Overload** ุดุฏู ุงุณุช:

```csharp
public delegate void ThreadStart();
public delegate void ParameterizedThreadStart (object obj);
```

---

## ๐งฉ Lambda Expressions ู ูุชุบุฑูุง Captured

ููุงูโุทูุฑ ฺฉู ุฏุฏูุ **Lambda Expression** ุฑุงุญุชโุชุฑู ู ูุฏุฑุชููุฏุชุฑู ุฑูุด ุจุฑุง ุงุฑุณุงู ุฏุงุฏู ุจู ฺฉ Thread ุงุณุช.
ุงูุง ุจุงุฏ ูุฑุงูุจ ุจุงุดุฏ ฺฉู ุจุนุฏ ุงุฒ ุดุฑูุน Threadุ ุจูโุทูุฑ ูุงุฎูุงุณุชู ูุชุบุฑูุง Captured ุฑุง ุชุบุฑ ูุฏูุฏ.

ุจุฑุง ููููู:

```csharp
for (int i = 0; i < 10; i++)
    new Thread (() => Console.Write (i)).Start();
```

ุฎุฑูุฌ **ูุงูุนู** ุงุณุช! ูุซุงู ุงุฒ ุฎุฑูุฌ:

```
0223557799
```

ูุดฺฉู ุงู ุงุณุช ฺฉู ูุชุบุฑ `i` ุฏุฑ ุทูู ุงุฌุฑุง ุญููู ุจู ฺฉ ูุญู ุญุงูุธูโ ูุดุชุฑฺฉ ุงุดุงุฑู ุฏุงุฑุฏ.
ุจูุงุจุฑุงู ูุฑ Threadุ ูุชุฏ ุฑุง ุฑู ูุชุบุฑ ูุฑุงุฎูุงู ูโฺฉูุฏ ฺฉู ููฺฉู ุงุณุช ููโุฒูุงู ุฏุฑ ุญุงู ุชุบุฑ ุจุงุดุฏ!

โ ุฑุงูโุญู: ุงุณุชูุงุฏู ุงุฒ ฺฉ ูุชุบุฑ ูููุช:

```csharp
for (int i = 0; i < 10; i++)
{
    int temp = i;
    new Thread (() => Console.Write (temp)).Start();
}
```

ุญุงูุง ูุฑ ุนุฏุฏ ุงุฒ **ฐ ุชุง น** ุฏููุงู ฺฉโุจุงุฑ ฺุงูพ ูโุดูุฏ.
(ุงูุจุชู ุชุฑุชุจ ูููุฒ ูุดุฎุต ูุณุชุ ฺูู Threadูุง ูโุชูุงููุฏ ุฏุฑ ุฒูุงูโูุง ูุงูุนู ุดุฑูุน ุดููุฏ.)

ุงู ูุดฺฉู ูุดุงุจู ููุถูุน **"Captured Variables"** (ุตูุญู ดณด) ุงุณุชุ
ูุดฺฉู ูู ุจู ููุงูู C# ุฏุฑ Capture ูุชุบุฑูุง ุญููู ูุฑุจูุท ูโุดูุฏ ู ูู ุจู Multithreading.

ุฏุฑ ุงู ุฑูุดุ ูุชุบุฑ `temp` ูุญู ุจู ูุฑ Iteration ุญููู ุงุณุชุ ูพุณ ูุฑ Thread ุญุงูุธูโุง ูุชูุงูุช Capture ูโฺฉูุฏ ู ูุดฺฉู ูพุด ููโุขุฏ.

ฺฉ ูุซุงู ุณุงุฏูโุชุฑ ุจุฑุง ููุงุด ูุดฺฉู:

```csharp
string text = "t1";
Thread t1 = new Thread ( () => Console.WriteLine (text) );
text = "t2";
Thread t2 = new Thread ( () => Console.WriteLine (text) );
t1.Start(); t2.Start();
```

ฺูู ูุฑ ุฏู Lambda ูุชุบุฑ `text` ุฑุง Capture ฺฉุฑุฏูโุงูุฏุ ุฎุฑูุฌ ุฏูุจุงุฑ `"t2"` ุฎูุงูุฏ ุจูุฏ.

---

## โ๏ธ ูุฏุฑุช ุงุณุชุซูุงูุง ุฏุฑ Threadูุง

ุจููฺฉโูุง **try/catch/finally** ฺฉู ููฺฏุงู ุงุฌุงุฏ ฺฉ Thread ุฏุฑ ุฌุฑุงู ูุณุชูุฏุ ูฺ ุชุฃุซุฑ ุฑู ุขู Thread ููฺฏุงู ุงุฌุฑุง ูุฏุงุฑูุฏ.

ูุซุงู:

```csharp
try
{
    new Thread (Go).Start();
}
catch (Exception ex)
{
    // ุงูุฌุง ูฺโููุช ุงุฌุฑุง ููโุดูุฏ!
    Console.WriteLine ("Exception!");
}

void Go() { throw null; }   // ูพุฑุชุงุจ NullReferenceException
```

ุฏุฑ ุงูุฌุงุ Thread ุฌุฏุฏ ุจุง ฺฉ **Unhandled NullReferenceException** ููุงุฌู ูโุดูุฏ.
ุงู ุฑูุชุงุฑ ููุทู ุงุณุชุ ฺูู ูุฑ Thread ูุณุฑ ุงุฌุฑุง ูุณุชูู ุฎูุฏ ุฑุง ุฏุงุฑุฏ.

โ ุฑุงูโุญู ุงู ุงุณุช ฺฉู **Exception Handler** ุฑุง ุฏุงุฎู ูุชุฏ `Go` ูุฑุงุฑ ุฏูู:

```csharp
new Thread (Go).Start();

void Go()
{
    try
    {
        ...
        throw null;    // ุงูุฌุง ุฎุทุง ูพุฑุชุงุจ ูโุดูุฏ
        ...
    }
    catch (Exception ex)
    {
        // ูุนูููุงู Exception ุฑุง Log ูโฺฉูู ุง ุจู ฺฉ Thread ุฏฺฏุฑ ุณฺฏูุงู ูโุฏูู
        ...
    }
}
```

ุฏุฑ ุจุฑูุงููโูุง ูุงูุนุ ุจุงุฏ ุฏุฑ ุชูุงู ูุชุฏูุง ูุฑูุฏ Thread **Exception Handler** ุฏุงุดุชู ุจุงุดุฏโููุงูโุทูุฑ ฺฉู ุฏุฑ Thread ุงุตู ุจุฑูุงูู ูู ูุงุฒ ุฏุงุฑุฏ.
ฺูู ฺฉ Exception ูุฏุฑุชโูุดุฏู ุจุงุนุซ ุจุณุชูโุดุฏู ฺฉู ุจุฑูุงูู ู ููุงุด ฺฉ ูพูุฌุฑูโ ูุงุฎูุดุงูุฏ ูโุดูุฏ.

---

## ๐๏ธ ูุฏุฑุช ูุชูุฑฺฉุฒ ุงุณุชุซูุงูุง

ุฏุฑ ุจุฑูุงููโูุง **WPFุ UWP ู Windows Forms** ูโุชูุงูุฏ ุจุฑุง ูุฏุฑุช ุณุฑุงุณุฑ Exceptionูุง ูุดุชุฑฺฉ ุดูุฏ:

* `Application.DispatcherUnhandledException`
* `Application.ThreadException`

ุงู ุฑูุฏุงุฏูุง ูพุณ ุงุฒ ูููุน ฺฉ Exception ูุฏุฑุชโูุดุฏู ุฏุฑ ูุฑ ุจุฎุด ุจุฑูุงูู ฺฉู ุงุฒ ุทุฑู Message Loop ูุฑุงุฎูุงู ุดุฏู ุงุณุช (ุนู ุชูุงู ฺฉุฏ ฺฉู ุฑู Thread ุงุตู ุฏุฑ ุญุงู ุงุฌุฑุงุณุช) ูุนุงู ูโุดููุฏ.

ุงู ุฑูุด ุจูโุนููุงู ฺฉ ูพุดุชูุงูู ุจุฑุง **Log ฺฉุฑุฏู ู ฺฏุฒุงุฑุด ุจุงฺฏโูุง** ููุฏ ุงุณุช (ูุฑฺูุฏ ุจุฑุง Exceptionูุง ูุฏุฑุชโูุดุฏู ุฑู Worker Threadูุง ูุนุงู ููโุดูุฏ).

ูุฏุฑุช ุงู ุฑูุฏุงุฏูุง ุงุฒ ุจุณุชูโุดุฏู ุจุฑูุงูู ุฌููฺฏุฑ ูโฺฉูุฏุ ุงูุจุชู ููฺฉู ุงุณุช ุชุตูู ุจฺฏุฑุฏ ุจุฑูุงูู ุฑุง ูุฌุฏุฏุงู ุฑุงูโุงูุฏุงุฒ ฺฉูุฏ ุชุง ุงุฒ ุญุงูุช ูุงูพุงุฏุงุฑ ุงุญุชูุงู ุฌููฺฏุฑ ุดูุฏ.

## ๐ Foreground ุฏุฑ ููุงุจู Background Threads

ุจูโุทูุฑ ูพุดโูุฑุถุ Threadูุง ฺฉู ุดูุง ุจูโุทูุฑ ุตุฑุญ ุงุฌุงุฏ ูโฺฉูุฏุ **Foreground** ูุณุชูุฏ.

๐น **Foreground Thread** ุจุงุนุซ ูโุดูุฏ ุจุฑูุงูู ุชุง ุฒูุงู ฺฉู ุญุช ฺฉ ุงุฒ ุขูโูุง ุฏุฑ ุญุงู ุงุฌุฑุงุณุชุ ุฒูุฏู ุจูุงูุฏ.
๐น **Background Thread** ฺูู ุงุซุฑ ูุฏุงุฑุฏุ ุจูโูุญุถ ุงูฺฉู ูููโ Foreground Threadูุง ุชูุงู ุดููุฏุ ุจุฑูุงูู ูพุงุงู ูโุงุจุฏ ู ูุฑ Background Thread ฺฉู ูููุฒ ุฏุฑ ุญุงู ุงุฌุฑุงุณุชุ ูุงฺฏูุงู ูุทุน ูโุดูุฏ.

โ๏ธ ูุถุนุช Foreground ุง Background ูฺ ุงุฑุชุจุงุท ุจุง **Priority** (ุงูููุช ุชุฎุตุต ุฒูุงู ูพุฑุฏุงุฒุด) ูุฏุงุฑุฏ.

ูโุชูุงูุฏ ูุถุนุช ฺฉ Thread ุฑุง ุงุฒ ุทุฑู ูฺฺฏ `IsBackground` ูพุฑุณโูุฌู ุง ุชุบุฑ ุฏูุฏ:

```csharp
static void Main (string[] args)
{
    Thread worker = new Thread ( () => Console.ReadLine() );
    if (args.Length > 0) worker.IsBackground = true;
    worker.Start();
}
```

* ุงฺฏุฑ ุจุฑูุงูู ุจุฏูู ุขุฑฺฏููุงู ุงุฌุฑุง ุดูุฏุ Thread ุจูโุตูุฑุช **Foreground** ุฎูุงูุฏ ุจูุฏ ู ููุชุธุฑ ูโูุงูุฏ ุชุง ฺฉุงุฑุจุฑ Enter ุจุฒูุฏ.
* ุงฺฏุฑ ุจุฑูุงูู ุจุง ุขุฑฺฏููุงู ุงุฌุฑุง ุดูุฏุ Thread ุจูโุตูุฑุช **Background** ุงุณุช ู ุจุฑูุงูู ุชูุฑุจุงู ุจูุงูุงุตูู ุชูุงู ูโุดูุฏ (ู `ReadLine` ูุทุน ูโฺฏุฑุฏุฏ).

โ ุชูุฌู: ููุช ุจุฑูุงูู ุงูโฺฏููู ูพุงุงู ุงุจุฏุ ุจูุงฺฉโูุง `finally` ุฏุฑ ูพุดุชูโ ุงุฌุฑุง Background Thread ุงุฌุฑุง ููโุดููุฏ.
ุจูุงุจุฑุงู ุงฺฏุฑ ุจุฑุง ูพุงฺฉโุณุงุฒ (ูุซู ุญุฐู ูุงูโูุง ูููุช) ุงุฒ `finally` ุง `using` ุงุณุชูุงุฏู ูโฺฉูุฏุ ุจุงุฏ ูุทูุฆู ุดูุฏ ููฺฏุงู ุฎุฑูุฌ ุงุฒ ุจุฑูุงููุ ุงู Threadูุง ุจูโุทูุฑ ุตุญุญ ุจู ูพุงุงู ุจุฑุณูุฏ (ูุซูุงู ุจุง `Join` ุง **Signaling**). ููุดู ูู ุจุงุฏ **Timeout** ุชุนู ฺฉูุฏ ุชุง ุฏุฑ ุตูุฑุช ูุฌุจุงุฒ ฺฉ Threadุ ุจุฑูุงูู ุจุณุชู ูุดูุฏ.

---

## ๐๏ธ ุงูููุช Threads

ูฺฺฏ `Priority` ุชุนู ูโฺฉูุฏ ฺฉ Thread ฺู ูุฒุงู ุฒูุงู ูพุฑุฏุงุฒุด ูุณุจุช ุจู ุณุงุฑ Threadูุง ุฏุฑุงูุช ฺฉูุฏ:

```csharp
enum ThreadPriority { Lowest, BelowNormal, Normal, AboveNormal, Highest }
```

ุงู ููุถูุน ุฒูุงู ุงููุช ุฏุงุฑุฏ ฺฉู ฺูุฏู Thread ููโุฒูุงู ูุนุงู ุจุงุดูุฏ.

* ุจุงูุง ุจุฑุฏู ุงูููุช ูโุชูุงูุฏ ุจุงุนุซ ุดูุฏ Threadูุง ุฏฺฏุฑ **ฺฏุฑุณูู** ุจูุงููุฏ.
* ุงฺฏุฑ ูโุฎูุงูุฏ Thread ุดูุง ุงูููุช ุจุงูุงุชุฑ ุงุฒ ุณุงุฑ Processูุง ุฏุงุดุชู ุจุงุดุฏุ ุจุงุฏ ุงูููุช Process ุฑุง ูู ุจุงูุง ุจุจุฑุฏ:

```csharp
using Process p = Process.GetCurrentProcess();
p.PriorityClass = ProcessPriorityClass.High;
```

ุงู ฺฉุงุฑ ุจุฑุง **ูพุฑุฏุงุฒุดโูุง ุบุฑ-UI ฺฉูฺฺฉ ุจุง ูุงุฒ ุจู ูุงฺฉูุด ุณุฑุน** ููุงุณุจ ุงุณุช. ุงูุง ุฏุฑ ุจุฑูุงููโูุง ูพุฑูุตุฑู (ูุฎุตูุตุงู ุจุง UI)ุ ุงูุฒุงุด ุงูููุช Process ูโุชูุงูุฏ ฺฉู ุณุณุชู ุฑุง ฺฉูุฏ ฺฉูุฏ.

---

## ๐ก Signaling

ฺฏุงู ูุงุฒู ุงุณุช ฺฉ Thread ููุชุธุฑ ุจูุงูุฏ ุชุง ุงุฒ Threadูุง ุฏฺฏุฑ ุณฺฏูุงู ุฏุฑุงูุช ฺฉูุฏ.
ุณุงุฏูโุชุฑู ุณุงุฒู ุจุฑุง ุงู ฺฉุงุฑ **ManualResetEvent** ุงุณุช:

* `WaitOne` โ Thread ูุนู ุฑุง ูุณุฏูุฏ ูโฺฉูุฏ.
* `Set` โ ุณฺฏูุงู ุฑุง ุจุงุฒ ูโฺฉูุฏ ู ููุชุธุฑูุง ุขุฒุงุฏ ูโุดููุฏ.

ูุซุงู:

```csharp
var signal = new ManualResetEvent (false);

new Thread (() =>
{
    Console.WriteLine ("Waiting for signal...");
    signal.WaitOne();
    signal.Dispose();
    Console.WriteLine ("Got signal!");
}).Start();

Thread.Sleep(2000);
signal.Set();  // ุณฺฏูุงู ุจุงุฒ ุดุฏ
```

ุจุนุฏ ุงุฒ ูุฑุงุฎูุงู `Set`ุ ุณฺฏูุงู ุจุงุฒ ูโูุงูุฏ ุชุง ุฒูุงู ฺฉู ุฏูุจุงุฑู `Reset` ุดูุฏ.
CLR ุณุงุฒูโูุง Signaling ูุชููุน ุฏุงุฑุฏ ฺฉู ุฏุฑ ูุตู ฒฑ ุจุฑุฑุณ ูโุดููุฏ.

---

## ๐ฅ๏ธ Threading ุฏุฑ ุจุฑูุงููโูุง Rich Client

ุฏุฑ ุจุฑูุงููโูุง **WPFุ UWP ู Windows Forms**ุ ุงุฌุฑุง ุนููุงุช ุทููุงู ุฑู Thread ุงุตู ุจุงุนุซ **ููฺฏ ฺฉุฑุฏู UI** ูโุดูุฏุ ฺูู ููุงู Thread ูุณุฆูู ูพุฑุฏุงุฒุด ูุฑูุฏโูุง (ฺฉุจูุฑุฏ/ูุงูุณ) ู ุฑูุฏุฑ ุฑุงุจุท ฺฉุงุฑุจุฑ ุงุณุช.

ุฑุงูโุญู:

* ุงุฌุงุฏ **Worker Thread** ุจุฑุง ฺฉุงุฑูุง ุฒูุงูโุจุฑ.
* ุณูพุณ ุงูุชูุงู ูุชุฌู ุจู Thread ุงุตู ุจุฑุง ุจูโุฑูุฒุฑุณุงู UI.

โ๏ธ ูููโ ุงู ูุฑูโูุฑฺฉโูุง ูุฏู Threading ุฏุงุฑูุฏ ฺฉู ููุท ุงุฌุงุฒู ูโุฏูุฏ UI ุชูุณุท ููุงู Thread ุฏุณุชุฑุณ ุงุจุฏ ฺฉู ุขู ุฑุง ุณุงุฎุชู ุงุณุช (ูุนูููุงู Thread ุงุตู). ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ุฑูุชุงุฑ ูุงูุดุฎุต ุง Exception ุฑุฎ ูโุฏูุฏ.

ุจุฑุง ุจูโุฑูุฒุฑุณุงู UI ุงุฒ Worker Thread ุจุงุฏ ุฏุฑุฎูุงุณุช ุฑุง ุจู UI Thread **Marshal** ฺฉูุฏ:

* **WPF** โ ุจุง `Dispatcher.BeginInvoke` ุง `Dispatcher.Invoke`
* **UWP** โ ุจุง `Dispatcher.RunAsync` ุง `Dispatcher.Invoke`
* **Windows Forms** โ ุจุง `Control.BeginInvoke` ุง `Control.Invoke`

`BeginInvoke`/`RunAsync` Delegate ุฑุง ุฏุฑ ุตู ูพุงู UI ูโฺฏุฐุงุฑูุฏ (ุบุฑูุณุฏูุฏฺฉููุฏู).
`Invoke` ููุงู ฺฉุงุฑ ุฑุง ูโฺฉูุฏุ ุงูุง ุชุง ูพุฑุฏุงุฒุด Delegate ุชูุณุท UI Thread ุตุจุฑ ูโฺฉูุฏ (ูุณุฏูุฏฺฉููุฏู ู ุจุง ุงูฺฉุงู ุจุงุฒฺฏุดุช ููุฏุงุฑ).

---

## ๐ ูุซุงู ุฏุฑ WPF

ูุฑุถ ฺฉูุฏ ฺฉ ูพูุฌุฑู WPF ุฏุงุฑู ฺฉู ุดุงูู TextBox ุจู ูุงู `txtMessage` ุงุณุช. ูโุฎูุงูู ูพุณ ุงุฒ ฺฉ ฺฉุงุฑ ุฒูุงูโุจุฑุ ูุชู ุขู ุฑุง ุชุบุฑ ุฏูู:

```csharp
partial class MyWindow : Window
{
    public MyWindow()
    {
        InitializeComponent();
        new Thread (Work).Start();
    }

    void Work()
    {
        Thread.Sleep (5000);           // ุดุจูโุณุงุฒ ฺฉุงุฑ ุฒูุงูโุจุฑ
        UpdateMessage ("The answer");
    }

    void UpdateMessage (string message)
    {
        Action action = () => txtMessage.Text = message;
        Dispatcher.BeginInvoke (action);
    }
}
```

๐น ูพูุฌุฑู ููุฑุงู ูพุงุณุฎโฺฏู ุฎูุงูุฏ ุจูุฏ.
๐น ุจุนุฏ ุงุฒ ต ุซุงููุ TextBox ุจูโุฑูุฒุฑุณุงู ูโุดูุฏ.

ุฏุฑ Windows Forms ูู ูุดุงุจู ุงุณุชุ ุจุง ุงู ุชูุงูุช ฺฉู ุจุงุฏ ุงุฒ ูุชุฏ `BeginInvoke` ูุฑู ุงุณุชูุงุฏู ฺฉูุฏ:

```csharp
void UpdateMessage (string message)
{
    Action action = () => txtMessage.Text = message;
    this.BeginInvoke (action);
}
```

---

## ๐ช ฺูุฏู UI Thread

ุฏุฑ ฺฉ ุจุฑูุงูู ูโุชูุงู ฺูุฏู UI Thread ุฏุงุดุชุ ูุฑฺฉุฏุงู ูุงูฺฉ ฺฉ **ูพูุฌุฑูโ ูุณุชูู**.
ุงู ูุนูููุงู ุฏุฑ **SDI Applications** (ูุซู Microsoft Word) ุงุณุชูุงุฏู ูโุดูุฏ. ูุฑ ูพูุฌุฑูโ ูุณุชูู ูโุชูุงูุฏ UI Thread ุฎูุฏุด ุฑุง ุฏุงุดุชู ุจุงุดุฏ ุชุง ูพุงุณุฎโฺฏู ุจุดุชุฑ ุจู ฺฉุงุฑุจุฑ ุงุฑุงุฆู ุฏูุฏ.

### ฺฉุงูุชฺฉุณุชโูุง ููฺฏุงูโุณุงุฒ (Synchronization Contexts) ๐

ุฏุฑ ูุถุง ูุงู **System.ComponentModel** ฺฉูุงุณ ุจู ูุงู **SynchronizationContext** ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ุงูฺฉุงู **ุนูููุช ุฏุงุฏู ุจู Thread Marshaling** ุฑุง ูุฑุงูู ูโฺฉูุฏ.

๐ฑ๐ป ุฏุฑ APIูุง ูุฑุจูุท ุจู rich-client ุจุฑุง ููุจุงู ู ุฏุณฺฉุชุงูพ (ุนู **UWPุ WPF ู Windows Forms**) ูุฑฺฉุฏุงู ุฒุฑฺฉูุงุณ ุงุฒ **SynchronizationContext** ุชุนุฑู ู ุงุฌุงุฏ ูโฺฉููุฏ. ุดูุง ูโุชูุงูุฏ ุงู ููููู ุฑุง ุงุฒ ุทุฑู ูฺฺฏ (Property) ุงุณุชุง ุจู ูุงู **SynchronizationContext.Current** (ููุช ุฑู ฺฉ UI thread ุฏุฑ ุญุงู ุงุฌุฑุง ูุณุชุฏ) ุจูโุฏุณุช ุขูุฑุฏ.

ฺฏุฑูุชู ุงู property ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ุจุนุฏุงู ุงุฒ ุฏุงุฎู ฺฉ worker thread ุจู ฺฉูุชุฑูโูุง UI โpostโ ฺฉูุฏ:

```csharp
partial class MyWindow : Window
{
    SynchronizationContext _uiSyncContext;

    public MyWindow()
    {
        InitializeComponent();
        // ฺฏุฑูุชู ฺฉุงูุชฺฉุณุช ููฺฏุงูโุณุงุฒ ุจุฑุง UI thread ุฌุงุฑ:
        _uiSyncContext = SynchronizationContext.Current;
        new Thread(Work).Start();
    }

    void Work()
    {
        Thread.Sleep(5000);   // ุดุจูโุณุงุฒ ฺฉ ฺฉุงุฑ ุฒูุงูโุจุฑ
        UpdateMessage("The answer");
    }

    void UpdateMessage(string message)
    {
        // Marshal ฺฉุฑุฏู delegate ุจู UI thread:
        _uiSyncContext.Post(_ => txtMessage.Text = message, null);
    }
}
```

๐ ุงู ุฑูุด ููุฏ ุงุณุช ฺูู ุฏุฑ ูููโ APIูุง ุฑุงุจุท ฺฉุงุฑุจุฑ rich-client ุจู ฺฉ ุดฺฉู ฺฉุงุฑ ูโฺฉูุฏ.

ูุฑุงุฎูุงู **Post** ูุนุงุฏู ูุฑุงุฎูุงู **BeginInvoke** ุฑู ฺฉ Dispatcher ุง Control ุงุณุช. ููฺูู ูุชุฏ ุจู ูุงู **Send** ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ูุนุงุฏู **Invoke** ุงุณุช.

---

### Thread Pool ๐โโ๏ธ

ููุช ฺฉ thread ุฌุฏุฏ ุงุฌุงุฏ ูโฺฉูุฏุ ฺูุฏ ุตุฏ ูฺฉุฑูุซุงูู ุตุฑู ุขูุงุฏูโุณุงุฒ ฺุฒูุง ูุซู stack ูุชุบุฑูุง ูุญู ูโุดูุฏ. **Thread Pool** ุงู overhead ุฑุง ฺฉุงูุด ูโุฏูุฏ ฺูู ุดุงูู ูุฌููุนูโุง ุงุฒ threadูุง ุงุฒ ูพุด ุณุงุฎุชูโุดุฏู ู ูุงุจู ุจุงุฒุงูุช ุงุณุช.

๐น ุงุณุชูุงุฏู ุงุฒ Thread Pool ุจุฑุง ุจุฑูุงููโููุณ ููุงุฒ ฺฉุงุฑุขูุฏ ู **Concurrency** ุฑุฒุฏุงููโุง ุถุฑูุฑ ุงุณุช. ุงู ฺฉุงุฑ ุงุฌุงุฒู ูโุฏูุฏ ุนููุงุชโูุง ฺฉูุชุงู ุงุฌุฑุง ุดููุฏ ุจุฏูู ุงูฺฉู overhead ุงุฌุงุฏ Thread ุฒุงุฏ ุดูุฏ.

ุงูุง ููฺฏุงู ุงุณุชูุงุฏู ุงุฒ pooled threadูุง ุจุงุฏ ฺูุฏ ูฺฉุชู ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ:

* ๐ซ ููโุชูุงูุฏ ุฎุงุตุช **Name** ุฑุง ุจุฑุง pooled threadูุง ุชูุธู ฺฉูุฏ (ุงุดฺฉุงูโุฒุฏุง ุณุฎุชโุชุฑ ูโุดูุฏุ ฺฏุฑฺู ุฏุฑ Visual Studio ูโุชูุงูุฏ ฺฉ description ุจู ุขูโูุง ุงุถุงูู ฺฉูุฏ).
* ๐ pooled threadูุง ููุดู **background thread** ูุณุชูุฏ.
* โ ุจูุงฺฉ ฺฉุฑุฏู pooled threadูุง ูโุชูุงูุฏ ุนููฺฉุฑุฏ ุฑุง ฺฉุงูุด ุฏูุฏ (ูฺฏุงู ฺฉูุฏ ุจู ยซHygiene in the thread poolยป).

ูโุชูุงูุฏ **Priority** ฺฉ pooled thread ุฑุง ุชุบุฑ ุฏูุฏุ ููุช thread ุขุฒุงุฏ ุดูุฏ ู ุจู Pool ุจุฑฺฏุฑุฏุฏุ ููุฏุงุฑุด ุฏูุจุงุฑู ุฑู Normal ุชูุธู ูโุดูุฏ.

ุจุฑุง ุจุฑุฑุณ ุงูฺฉู ุขุง ุฏุฑ ุญุงู ุญุงุถุฑ ุฑู ฺฉ pooled thread ุฏุฑ ุญุงู ุงุฌุฑุง ูุณุชุฏ ุง ููุ ูโุชูุงูุฏ ุงุฒ ุฎุงุตุช **Thread.CurrentThread.IsThreadPoolThread** ุงุณุชูุงุฏู ฺฉูุฏ.

---

### ูุฑูุฏ ุจู Thread Pool ๐

ุณุงุฏูโุชุฑู ุฑุงู ุงุฌุฑุง ุตุฑุญ ฺฉ ฺฉุงุฑ ุฏุฑ thread pool ุงุณุชูุงุฏู ุงุฒ **Task.Run** ุงุณุช (ุงู ููุถูุน ุฑุง ุฏุฑ ุจุฎุด ุจุนุฏ ฺฉุงููโุชุฑ ุชูุถุญ ูโุฏูู):

```csharp
// Task ุฏุฑ ูุถุง ูุงู System.Threading.Tasks ุงุณุช
Task.Run(() => Console.WriteLine("Hello from the thread pool"));
```

ูุจู ุงุฒ ูุณุฎูโ **.NET Framework 4.0** ฺฉู Task ูุฌูุฏ ูุฏุงุดุชุ ุฑูุด ุฑุงุฌ ุงุณุชูุงุฏู ุงุฒ **ThreadPool.QueueUserWorkItem** ุจูุฏ:

```csharp
ThreadPool.QueueUserWorkItem(notUsed => Console.WriteLine("Hello"));
```

ููฺูู ุงุณุชูุงุฏูโูุง ุฒุฑ ุจูโุทูุฑ ุถูู ุงุฒ thread pool ุจูุฑู ูโุจุฑูุฏ:

* ๐ ุณุฑูุฑูุง ุงูพูฺฉุดู **ASP.NET Core** ู **Web API**
* โฑ๏ธ ฺฉูุงุณโูุง **System.Timers.Timer** ู **System.Threading.Timer**
* ๐ ุณุงุฎุชุงุฑูุง ุจุฑูุงููโููุณ ููุงุฒ (ุชูุถุญ ุฏุฑ ูุตู 22)
* โ๏ธ ฺฉูุงุณ ูุฏู **BackgroundWorker**

---

### ุฑุนุงุช ุจูุฏุงุดุช ุฏุฑ Thread Pool ๐งน

Thread Pool ูุธูู ุฏฺฏุฑ ูู ุฏุงุฑุฏ: ุฌููฺฏุฑ ุงุฒ ุงุฌุงุฏ **oversubscription**.

โ Oversubscription ุนู ุชุนุฏุงุฏ threadูุง ูุนุงู ุจุดุชุฑ ุงุฒ ุชุนุฏุงุฏ ูุณุชูโูุง CPU ุจุงุดุฏ ู ุณุณุชูโุนุงูู ูุฌุจูุฑ ุดูุฏ ุจู ุขูโูุง time-slice ุงูุฌุงู ุฏูุฏ. ุงู ฺฉุงุฑ ฺฉุงุฑุง ุฑุง ฺฉุงูุด ูโุฏูุฏ ฺูู context switch ูพุฑูุฒูู ุงุณุช ู cacheูุง CPU ุฑุง ูู ุจโุงุนุชุจุงุฑ ูโฺฉูุฏ.

โ CLR ุงุฒ oversubscription ุฌููฺฏุฑ ูโฺฉูุฏ ุจุง:

* ุตูโุจูุฏ (queue) ฺฉุฑุฏู ุชุณฺฉโูุง
* ู ฺฉูุชุฑู ุดุฑูุน ุขูโูุง

ุงูู ุจู ุงูุฏุงุฒู ุชุนุฏุงุฏ ูุณุชูโูุง ุณุฎุชโุงูุฒุงุฑ ุชุณฺฉโูุง ุฑุง ุจูโุทูุฑ ููุฒูุงู ุงุฌุฑุง ูโฺฉูุฏุ ุณูพุณ ุจุง ุงุณุชูุงุฏู ุงุฒ ฺฉ ุงูฺฏูุฑุชู hill-climbing ุณุทุญ Concurrency ุฑุง ุชูุธู ูโฺฉูุฏ. ุงฺฏุฑ throughput ุจูุชุฑ ุดูุฏุ ุฏุฑ ููุงู ุฌูุช ุงุฏุงูู ูโุฏูุฏ ูฺฏุฑูู ูุณุฑุด ุฑุง ุนูุถ ูโฺฉูุฏ.

ุงู ุงุณุชุฑุงุชฺ ุฏุฑ ุตูุฑุช ุจูุชุฑู ุนููฺฉุฑุฏ ุฑุง ุฏุงุฑุฏ ฺฉู:

1. ๐ ฺฉุงุฑูุง ฺฉูุชุงูโูุฏุช ุจุงุดูุฏ (ฺฉูุชุฑ ุงุฒ ฒตฐ ููโุซุงููุ ู ุชุฑุฌุญุงู ุฒุฑ ฑฐฐ ููโุซุงูู).
2. ๐ซ ฺฉุงุฑูุง ฺฉู ุจุดุชุฑ ููุชุดุงู ุฑุง ุฏุฑ ุญุงูุช **Blocked** ูุณุชูุฏุ ุบุงูุจ ูุจุงุดูุฏ.

ุจูุงฺฉ ุดุฏู ูุดฺฉูโุณุงุฒ ุงุณุช ฺูู CLR ุชุตูุฑ ูโฺฉูุฏ CPU ุฏุฑฺฏุฑ ุงุณุช. CLR ููุดููุฏ ุงุณุช ู ุจุฑุง ุฌุจุฑุงู threadูุง ุจุดุชุฑ ูุงุฑุฏ Pool ูโฺฉูุฏุ ุงูุง ุงู ฺฉุงุฑ ูโุชูุงูุฏ ุฏูุจุงุฑู ุจู oversubscription ููุฌุฑ ุดูุฏ ู ููฺูู ุจุงุนุซ ุชุฃุฎุฑ (latency) ุดูุฏุ ูุฎุตูุตุงู ุฏุฑ ุงุจุชุฏุง ุงุฌุฑุง ุงูพูฺฉุดู (ุจุดุชุฑ ุฏุฑ ุณุณุชูโุนุงููโูุง client ฺฉู ูุตุฑู ููุงุจุน ูพุงูโุชุฑ ุชุฑุฌุญ ุฏุงุฏู ูโุดูุฏ).

๐ ุฑุนุงุช ุจูุฏุงุดุช ุฏุฑ Thread Pool ููุช ุงููุช ุจุดุชุฑ ุฏุงุฑุฏ ฺฉู ุจุฎูุงูุฏ CPU ุฑุง ุจูโุทูุฑ ฺฉุงูู ุงุณุชูุงุฏู ฺฉูุฏ (ูุซูุงู ุจุง ุงุณุชูุงุฏู ุงุฒ APIูุง ุจุฑูุงููโููุณ ููุงุฒ ุฏุฑ ูุตู 22).
### ุชุณฺฉโูุง (Tasks) โก

๐น ฺฉ **Thread** ุงุจุฒุงุฑ ุณุทุญ ูพุงู ุจุฑุง ุงุฌุงุฏ **Concurrency** ุงุณุช ู ูุญุฏูุฏุชโูุง ุฏุงุฑุฏุ ุงุฒ ุฌููู:

* ๐ฅ ุงฺฏุฑฺู ูุฑุณุชุงุฏู ุฏุงุฏู ุจู ุฏุงุฎู ฺฉ Thread ฺฉู ุงุฌุงุฏ ฺฉุฑุฏูโุงุฏ ุณุงุฏู ุงุณุชุ ฺฏุฑูุชู ฺฉ **ููุฏุงุฑ ุจุงุฒฺฏุดุช (return value)** ุงุฒ Thread ฺฉู Join ฺฉุฑุฏูโุงุฏ ุขุณุงู ูุณุช. ุจุงุฏ ฺฉ **ููุฏ ูุดุชุฑฺฉ** ุชูุธู ฺฉูุฏ. ููฺูู ุงฺฏุฑ ุนููุงุช ฺฉ **Exception** ูพุฑุชุงุจ ฺฉูุฏุ ฺฏุฑูุชู ู ููุชูู ฺฉุฑุฏู ุขู ูู ุฏุฑุฏุณุฑ ุฏุงุฑุฏ.
* ๐ ููโุชูุงูุฏ ุจู Thread ุจฺฏูุฏ ููุช ุชูุงู ุดุฏ ฺุฒ ุฏฺฏุฑ ุฑุง ุดุฑูุน ฺฉูุฏุ ุจูฺฉู ุจุงุฏ ุขู ุฑุง Join ฺฉูุฏ (ฺฉู ุจุงุนุซ ุจูุงฺฉ ุดุฏู Thread ุฎูุฏุชุงู ูโุดูุฏ).

ุงู ูุญุฏูุฏุชโูุง ุจุงุนุซ ูโุดููุฏ **Concurrency ุฑุฒุฏุงููโุง (fine-grained)** ุณุฎุช ุดูุฏุ ุนู ุชุฑฺฉุจ ุนููุงุชโูุง ฺฉูฺฺฉโุชุฑ ุจุฑุง ุณุงุฎุช ุนููุงุชโูุง ููุฒูุงู ุจุฒุฑฺฏโุชุฑ ูุดฺฉู ุงุณุช (ฺฉู ุจุฑุง **ุจุฑูุงููโููุณ Asynchronous** ุญุงุช ุงุณุช). ุฏุฑ ูุชุฌู ูุงุฒ ุจู **synchronization ุฏุณุช** (ูุซู Lockingุ Signaling ู ุบุฑู) ุจุดุชุฑ ูโุดูุฏ ฺฉู ุฎูุฏุด ูุดฺฉูุงุช ุฏฺฏุฑ ุฏุงุฑุฏ.

ููฺูู ุงุณุชูุงุฏู ูุณุชูู ุงุฒ Threadูุง ุงุซุฑุงุช ููู ุฑู **ฺฉุงุฑุง** ุฏุงุฑุฏ (ุชูุถุญ ุฏุฑ ุจุฎุด ยซThread Poolยป). ุงฺฏุฑ ูุงุฒ ุจู ุงุฌุฑุง ุตุฏูุง ุง ูุฒุงุฑุงู ุนููุงุช I/O ููุฒูุงู ุฏุงุดุชู ุจุงุดุฏุ ุฑูฺฉุฑุฏ Threadโูุญูุฑ ุจุงุนุซ ูุตุฑู ุตุฏูุง ุง ูุฒุงุฑุงู ูฺฏุงุจุงุช ุญุงูุธู ุตุฑูุงู ุจุฑุง overhead ูุฑุจูุท ุจู Threadูุง ูโุดูุฏ.

โ ฺฉูุงุณ **Task** ุจู ููู ุงู ูุดฺฉูุงุช ฺฉูฺฉ ูโฺฉูุฏ. **Task** ูุณุจุช ุจู Thread ฺฉ **ุงูุชุฒุงุน ุณุทุญ ุจุงูุงุชุฑ** ุงุณุชุ ุนู ูุดุงูโุฏููุฏู ฺฉ ุนููุงุช ููุฒูุงู ุงุณุช ฺฉู ููฺฉู ุงุณุช ูพุดุชุจุงูโุดุฏู ุชูุณุท Thread ุจุงุดุฏ ุง ูุจุงุดุฏ.

ูฺฺฏโูุง:

* ๐ **Taskูุง ุชุฑฺฉุจโูพุฐุฑ (compositional)** ูุณุชูุฏ (ูโุชูุงูุฏ ุขูโูุง ุฑุง ุจุง ุงุณุชูุงุฏู ุงุฒ Continuationูุง ุจู ูู ุฒูุฌุฑ ฺฉูุฏ).
* ๐ ูโุชูุงููุฏ ุงุฒ Thread Pool ุงุณุชูุงุฏู ฺฉููุฏ ุชุง ุฒูุงู ุดุฑูุน ุฑุง ฺฉู ฺฉููุฏ.
* ๐ ุจุง ุงุณุชูุงุฏู ุงุฒ **TaskCompletionSource** ูโุชูุงููุฏ ุฑูฺฉุฑุฏ Callback ุฑุง ูพุงุฏูโุณุงุฒ ฺฉููุฏ ฺฉู ุงุตูุงู ูุงุฒ ุจู Threadูุง ูุฏุงุฑุฏ (ููุงุณุจ ุจุฑุง ุนููุงุช I/O-bound).

ฺฉูุงุณโูุง Task ุฏุฑ **.NET Framework 4.0** ุจูโุนููุงู ุจุฎุด ุงุฒ ฺฉุชุงุจุฎุงูู ุจุฑูุงููโููุณ ููุงุฒ ูุนุฑู ุดุฏูุฏุ ู ุจุนุฏุงู ุจุง **awaiters** ุจูุจูุฏ ูพุฏุง ฺฉุฑุฏูุฏ ุชุง ุฏุฑ ุณูุงุฑููุง ุนููู Concurrency ูู ุฎูุจ ฺฉุงุฑ ฺฉููุฏ. ุขูโูุง ููฺูู ูพุงูโ **ุชูุงุจุน Asynchronous ุฏุฑ C#** ูุณุชูุฏ.

(ุฏุฑ ุงู ุจุฎุดุ ูฺฺฏโูุง Task ูุฑุชุจุท ุจุง **ุจุฑูุงููโููุณ ููุงุฒ** ุฑุง ฺฉูุงุฑ ูโฺฏุฐุงุฑู ู ุฏุฑ ูุตู 22 ุจู ุขูโูุง ูโูพุฑุฏุงุฒู.)

---

### ุดุฑูุน ฺฉ Task โถ๏ธ

ุณุงุฏูโุชุฑู ุฑุงู ุจุฑุง ุดุฑูุน ฺฉ Task ูพุดุชุจุงูโุดุฏู ุชูุณุท Thread ุงุณุชูุงุฏู ุงุฒ ูุชุฏ ุงุณุชุง **Task.Run** ุงุณุช (ฺฉูุงุณ Task ุฏุฑ ูุถุง ูุงู **System.Threading.Tasks** ุงุณุช):

```csharp
Task.Run(() => Console.WriteLine("Foo"));
```

ุจูโุทูุฑ ูพุดโูุฑุถุ Taskูุง ุฑู **Thread Pool** ุงุฌุฑุง ูโุดููุฏ ฺฉู **background thread** ูุณุชูุฏ.
ุนู ููุช **main thread** ุชูุงู ุดูุฏุ ููู Taskูุง ฺฉู ุณุงุฎุชูโุงุฏ ูู ูุชููู ูโุดููุฏ.

ูพุณ ุฏุฑ ฺฉ **Console Application**ุ ุจุงุฏ main thread ุฑุง ุจุนุฏ ุงุฒ ุดุฑูุน Task ุจูุงฺฉ ฺฉูุฏ (ูุซูุงู ุจุง **Wait** ุฑู Task ุง ุจุง **Console.ReadLine**):

```csharp
Task.Run(() => Console.WriteLine("Foo"));
Console.ReadLine();
```

ุฏุฑ **LINQPad** ูุงุฒ ุจู `Console.ReadLine` ูุณุชุ ฺูู ูพุฑูุณูโ LINQPad ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ background threadูุง ุฑุง ุฒูุฏู ูฺฏู ูโุฏุงุฑุฏ.

ูุฑุงุฎูุงู **Task.Run** ุชูุฑุจุงู ุดุจู ุจู ุงุฌุงุฏ ฺฉ Thread ุงุณุช:

```csharp
new Thread(() => Console.WriteLine("Foo")).Start();
```

ุงูุง `Task.Run` ฺฉ **Task object** ุจุฑูโฺฏุฑุฏุงูุฏ ฺฉู ูโุชูุงูู ูุถุนุช ูพุดุฑูุช ุขู ุฑุง ูุงูุชูุฑ ฺฉูู (ูุดุงุจู Thread object).
ุชูุฌู ฺฉูุฏ ฺฉู ุจุนุฏ ุงุฒ `Task.Run` ุฏฺฏุฑ **Start** ููโุฒูู ฺูู ุงู ูุชุฏ **Hot Task** ุงุฌุงุฏ ูโฺฉูุฏ. (ูโุชูุงูุฏ ุจุง ุณุงุฒูุฏูโ Task ฺฉ **Cold Task** ุจุณุงุฒุฏุ ุงูุง ุฏุฑ ุนูู ฺฉูโุงุณุชูุงุฏู ุงุณุช.)

ูโุชูุงูุฏ ูุถุนุช ุงุฌุฑุง Task ุฑุง ุงุฒ ุทุฑู ุฎุงุตุช **Status** ุจุฑุฑุณ ฺฉูุฏ.

---

### Wait โณ

ูุฑุงุฎูุงู **Wait** ุฑู ฺฉ Task ุจุงุนุซ ุจูุงฺฉ ุดุฏู ูโุดูุฏ ุชุง Task ฺฉุงูู ุดูุฏ (ูุดุงุจู ูุฑุงุฎูุงู **Join** ุฑู ฺฉ Thread):

```csharp
Task task = Task.Run(() =>
{
    Thread.Sleep(2000);
    Console.WriteLine("Foo");
});
Console.WriteLine(task.IsCompleted);  // False
task.Wait();  // ุชุง ุชฺฉูู Task ุจูุงฺฉ ูโุดูุฏ
```

ูุชุฏ Wait ุงูฺฉุงู ุชุนู **Timeout** ู **CancellationToken** ุฑุง ูู ูโุฏูุฏ (ุชูุถุญ ุฏุฑ ุจุฎุด ยซCancellationยป ุตูุญู 681).

---

### Long-running Tasks ๐ข

ุจูโุทูุฑ ูพุดโูุฑุถุ CLR ุชุณฺฉโูุง ุฑุง ุฑู pooled threads ุงุฌุฑุง ูโฺฉูุฏ ฺฉู ุจุฑุง ฺฉุงุฑูุง **ฺฉูุชุงูโูุฏุช ู compute-bound** ุงุฏูโุขู ุงุณุช.

ุจุฑุง ฺฉุงุฑูุง **ุจููุฏูุฏุช ุง blocking** ูโุชูุงูุฏ ูุงูุน ุงุณุชูุงุฏู ุงุฒ pooled thread ุดูุฏ:

```csharp
Task task = Task.Factory.StartNew(() => ...,
    TaskCreationOptions.LongRunning);
```

ุงุฌุฑุง ฺฉ ุชุณฺฉ ุจููุฏูุฏุช ุฑู ฺฉ pooled thread ูุดฺฉู ูุฏุงุฑุฏุ ุงูุง ุงฺฏุฑ ฺูุฏู ุชุณฺฉ ุจููุฏูุฏุช ููุงุฒ ุงุฌุฑุง ุดููุฏ (ุฎุตูุตุงู ุขูโูุง ฺฉู Block ูโุดููุฏ)ุ ุนููฺฉุฑุฏ ฺฉุงูุด ูโุงุจุฏ.

ุฑุงูฺฉุงุฑูุง ุจูุชุฑ ุฏุฑ ุงู ุญุงูุช:

* ุงฺฏุฑ ุชุณฺฉโูุง **I/O-bound** ูุณุชูุฏ: ุงุฒ **TaskCompletionSource** ู ุชูุงุจุน **Asynchronous** ุจุฑุง ูพุงุฏูโุณุงุฒ Concurrency ุจุง Callbackูุง ุงุณุชูุงุฏู ฺฉูุฏ.
* ุงฺฏุฑ ุชุณฺฉโูุง **Compute-bound** ูุณุชูุฏ: ุงุฒ ฺฉ **Producer/Consumer Queue** ุงุณุชูุงุฏู ฺฉูุฏ ุชุง Concurrency ุฑุง ฺฉูุชุฑู ฺฉุฑุฏู ู ุฌูู ฺฏุฑุณูฺฏ ุณุงุฑ Threadูุง ู ูพุฑูุณูโูุง ุฑุง ุจฺฏุฑุฏ (ุชูุถุญ ุฏุฑ ยซProducer/Consumer Queueยป ุตูุญู 970).

---

### ุจุงุฒฺฏุฑุฏุงูุฏู ููุงุฏุฑ ๐ข

ฺฉูุงุณ Task ฺฉ ุฒุฑฺฉูุงุณ ุฌูุฑฺฉ ุจู ูุงู **Task<TResult>** ุฏุงุฑุฏ ฺฉู ุงุฌุงุฒู ูโุฏูุฏ ฺฉ ููุฏุงุฑ ุจุงุฒฺฏุดุช ุชููุฏ ฺฉูุฏ.

ูโุชูุงูุฏ ุจุง ุฏุงุฏู ฺฉ **Func<TResult>** (ุง lambda expression ุณุงุฒฺฏุงุฑ) ุจู Task.Run ฺฉ Task<TResult> ุจุณุงุฒุฏ:

```csharp
Task<int> task = Task.Run(() => 
{ 
    Console.WriteLine("Foo"); 
    return 3; 
});
int result = task.Result;   // ุจูุงฺฉ ูโุดูุฏ ุชุง Task ุชูุงู ุดูุฏ
Console.WriteLine(result);  // 3
```

ููููู: ูุญุงุณุจู ุชุนุฏุงุฏ ุงุนุฏุงุฏ ุงูู ุฏุฑ ุณู ูููู ุนุฏุฏ ุงูู:

```csharp
Task<int> primeNumberTask = Task.Run(() =>
    Enumerable.Range(2, 3000000)
              .Count(n => Enumerable.Range(2, (int)Math.Sqrt(n)-1)
              .All(i => n % i > 0)));

Console.WriteLine("Task running...");
Console.WriteLine("The answer is " + primeNumberTask.Result);
```

ุฎุฑูุฌ:

```
Task running...
The answer is 216816
```

---

### ูุฏุฑุช Exceptionูุง โ๏ธ

๐ฎ **Task<TResult>** ุดุจู ฺฉ *Future* ุงุณุชุ ุนู ูุชุฌูโุง ุฑุง ุฏุฑ ุขูุฏู ูฺฏู ูโุฏุงุฑุฏ.
ุจุฑุฎูุงู Threadูุงุ ุชุณฺฉโูุง Exceptionูุง ุฑุง ุฑุงุญุช ููุชูู ูโฺฉููุฏ.

ุงฺฏุฑ ฺฉุฏ ุฏุงุฎู Task ฺฉ Exception ูุฏุฑุชโูุดุฏู ูพุฑุชุงุจ ฺฉูุฏ:

* ุงฺฏุฑ Wait ฺฉูุฏ ุง ุจู Result ุฏุณุชุฑุณ ุจุฒูุฏุ Exception ุฏูุจุงุฑู ูพุฑุชุงุจ ูโุดูุฏ.

```csharp
// ุดุฑูุน ฺฉ Task ฺฉู NullReferenceException ูพุฑุชุงุจ ูโฺฉูุฏ:
Task task = Task.Run(() => { throw null; });

try
{
    task.Wait();
}
catch (AggregateException aex)
{
    if (aex.InnerException is NullReferenceException)
        Console.WriteLine("Null!");
    else
        throw;
}
```

๐งฉ CLR Exception ุฑุง ุฏุฑ ฺฉ **AggregateException** ุจุณุชูโุจูุฏ ูโฺฉูุฏ ุชุง ุจุง ุณูุงุฑููุง ุจุฑูุงููโููุณ ููุงุฒ ููโุฎูุงู ุฏุงุดุชู ุจุงุดุฏ (ุชูุถุญ ุฏุฑ ูุตู 22).

ูโุชูุงูุฏ ุจุฏูู ูพุฑุชุงุจ Exception ุจุฑุฑุณ ฺฉูุฏ ฺฉู ุขุง Task Faulted ุดุฏู ุง ููุ ุจุง ุงุณุชูุงุฏู ุงุฒ ูฺฺฏโูุง:

* **IsFaulted**
* **IsCanceled**

ุงฺฏุฑ ูุฑ ุฏู `false` ุจุงุดูุฏุ ุฎุทุง ุฑุฎ ูุฏุงุฏู.

* ุงฺฏุฑ `IsCanceled = true` ุจุงุดุฏุ ุนู ฺฉ **OperationCanceledException** ูพุฑุชุงุจ ุดุฏู (ุชูุถุญ ุฏุฑ ุจุฎุด ยซCancellationยป ุตูุญู 941).
* ุงฺฏุฑ `IsFaulted = true` ุจุงุดุฏุ ููุน ุฏฺฏุฑ ุงุฒ Exception ุฑุฎ ุฏุงุฏู ู ุฎุงุตุช **Exception** ุฌุฒุฆุงุช ุฎุทุง ุฑุง ูุดุงู ูโุฏูุฏ.

### ุงุณุชุซูุงูุง ู Taskูุง ูุณุชูู ๐จ

ุฏุฑ ููุฑุฏ Taskูุง ูุณุชูู ุง ููุงู **set-and-forget** (ุนู ุขูโูุง ฺฉู ุดูุง ุฏฺฏุฑ ุจุง `Wait()` ุง `Result` ุง continuation ุจู ุณุฑุงุบุดุงู ููโุฑูุฏ)ุ ฺฉ **ุฑูุด ุฏุฑุณุช** ุงู ุงุณุช ฺฉู ุญุชูุงู ฺฉุฏ Task ุฑุง ุจูโุตูุฑุช ุตุฑุญ ูุฏุฑุช ุงุณุชุซูุง ุจููุณุฏ ุชุง ุงุฒ ุดฺฉุณุชโูุง ุฎุงููุด ุฌููฺฏุฑ ฺฉูุฏุ ุฏููุงู ููุงูโุทูุฑ ฺฉู ุฏุฑ ฺฉ Thread ุนุงุฏ ุนูู ูโฺฉูุฏ.

ูุงุฏุฏู ฺฏุฑูุชู ุงุณุชุซูุงูุง ุฒูุงู ูุดฺฉู ูุฏุงุฑุฏ ฺฉู ุขู ุงุณุชุซูุง ููุท ุจู ูุนู ุดฺฉุณุช ุฏุฑ ฺฏุฑูุชู ูุชุฌูโุง ุจุงุดุฏ ฺฉู ุฏฺฏุฑ ุจู ุขู ุนูุงููโุง ูุฏุงุฑุฏ.
๐ ุจุฑุง ูุซุงูุ ุงฺฏุฑ ฺฉุงุฑุจุฑ ุฏุฑุฎูุงุณุช ุฏุงูููุฏ ฺฉ ุตูุญู ูุจ ุฑุง ูุบู ฺฉูุฏุ ุจุฑุงูุงู ููู ูุณุช ฺฉู ุฏุฑ ุงุฏุงูู ูุดุฎุต ุดูุฏ ุขู ุตูุญู ุงุตูุงู ูุฌูุฏ ูุฏุงุดุชู ุงุณุช.

ุงูุง ูุงุฏุฏู ฺฏุฑูุชู ุงุณุชุซูุง ุฒูุงู ูุดฺฉูโุณุงุฒ ูโุดูุฏ ฺฉู ุขู ุงุณุชุซูุง ูุดุงูโุฏููุฏูโ ฺฉ **ุจุงฺฏ ุฏุฑ ุจุฑูุงูู** ุจุงุดุฏุ ุจู ุฏู ุฏูู:

* ๐ ููฺฉู ุงุณุช ุจุงฺฏ ุจุงุนุซ ุดูุฏ ุจุฑูุงูู ุฏุฑ ฺฉ ูุถุนุช ูุงูุนุชุจุฑ ุจุงู ุจูุงูุฏ.
* ๐งฉ ุงุญุชูุงู ุฏุงุฑุฏ ุงุณุชุซูุงูุง ุจุดุชุฑ ุฏุฑ ุขูุฏู ุฑุฎ ุฏููุฏ ู ุงฺฏุฑ ุฎุทุง ุงููู ุซุจุช (log) ูุดูุฏุ ุชุดุฎุต ูุดฺฉู ุณุฎุช ุฎูุงูุฏ ุดุฏ.

ุดูุง ูโุชูุงูุฏ ุงุณุชุซูุงูุง ูุดุงูุฏูโูุดุฏู ุฑุง ุฏุฑ ุณุทุญ ุณุฑุงุณุฑ ูุฏุฑุช ฺฉูุฏุ ุงุฒ ุทุฑู ุฑูุฏุงุฏ ุงุณุชุงุชฺฉ `TaskScheduler.UnobservedTaskException`. ูุฏุฑุช ุงู ุฑูุฏุงุฏ ู ุซุจุช ุฎุทุง ูโุชูุงูุฏ ุจุณุงุฑ ููุทู ุจุงุดุฏ.

---

### ูฺฉุงุช ุธุฑู ุฏุฑุจุงุฑูโ ุงุณุชุซูุงูุง ูุดุงูุฏูโูุดุฏู ๐ต๏ธโโ๏ธ

ฺูุฏ ูฺฉุชู ุฌุงูุจ ุฏุฑ ููุฑุฏ ุงูฺฉู ฺู ฺุฒ **unobserved** ูุญุณูุจ ูโุดูุฏ ูุฌูุฏ ุฏุงุฑุฏ:

* ุงฺฏุฑ ุฑู ฺฉ Task ุจุง ุฒูุงูโุจูุฏ (timeout) ููุชุธุฑ ุจูุงูุฏ ู ุฎุทุง ุจุนุฏ ุงุฒ ูพุงุงู ุฒูุงู ุฑุฎ ุฏูุฏุ ุขู ุฎุทุง ุจูโุนููุงู ุงุณุชุซูุง ูุดุงูุฏูโูุดุฏู ุฏุฑ ูุธุฑ ฺฏุฑูุชู ูโุดูุฏ.
* ููู ฺฉู ูฺฺฏ `Exception` ฺฉ Task ุฑุง ุจุนุฏ ุงุฒ fault ุดุฏู ุจุฑุฑุณ ฺฉูุฏุ ุขู ุงุณุชุซูุง ยซobservedยป ูุญุณูุจ ูโุดูุฏ.

---

### Continuations ๐

ฺฉ Continuation ุจู ฺฉ Task ูโฺฏูุฏ: ยซููุช ฺฉุงุฑุช ุชูุงู ุดุฏุ ุงุฏุงูู ุจุฏู ู ฺฉ ฺฉุงุฑ ุฏฺฏุฑ ุงูุฌุงู ุจุฏู.ยป
ูุนูููุงู Continuation ุจูโุตูุฑุช ฺฉ **callback** ูพุงุฏูโุณุงุฒ ูโุดูุฏ ฺฉู ุฏุฑุณุช ูพุณ ุงุฒ ุงุชูุงู ุนููุงุช ุงุฌุฑุง ูโฺฏุฑุฏุฏ.

ุฏู ุฑูุด ุจุฑุง ุงุชุตุงู Continuation ุจู ฺฉ Task ูุฌูุฏ ุฏุงุฑุฏ. ุฑูุด ุงูู ุงููุช ูฺูโุง ุฏุงุฑุฏุ ฺูู ุชูุณุท ุชูุงุจุน **asynchronous ุฏุฑ C#** ุงุณุชูุงุฏู ูโุดูุฏ. ูุซุงู ุฒุฑ ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ (ููุงู ูุซุงู ุดูุงุฑุด ุงุนุฏุงุฏ ุงูู):

```csharp
Task<int> primeNumberTask = Task.Run(() =>
  Enumerable.Range(2, 3000000).Count(n => 
    Enumerable.Range(2, (int)Math.Sqrt(n) - 1).All(i => n % i > 0)));

var awaiter = primeNumberTask.GetAwaiter();
awaiter.OnCompleted(() =>
{
  int result = awaiter.GetResult();
  Console.WriteLine(result); // ููุงุด ูุชุฌู
});
```

ูุฑุงุฎูุงู `GetAwaiter` ุฑู ฺฉ Taskุ ฺฉ **awaiter object** ุจุฑูโฺฏุฑุฏุงูุฏ ฺฉู ูุชุฏ `OnCompleted` ุขูุ ุจู Task ูโฺฏูุฏ ูพุณ ุงุฒ ูพุงุงู (ุง ุฎุทุง)ุ ฺฉุฏุงู delegate ุงุฌุฑุง ุดูุฏ.
ุญุช ูโุชูุงูุฏ ฺฉ Continuation ุฑุง ุฑู Task ฺฉู ูุจูุงู ฺฉุงูู ุดุฏู ูุตู ฺฉูุฏุ ุฏุฑ ุงู ุตูุฑุชุ Continuation ุจูุงูุงุตูู ุฒูุงูโุจูุฏ ู ุงุฌุฑุง ูโุดูุฏ.

ฺฉ **awaiter** ูุฑ ุดุฆ ุงุณุช ฺฉู ุฏู ูุชุฏ (`OnCompleted` ู `GetResult`) ู ฺฉ ูฺฺฏ ุจูู (`IsCompleted`) ุฏุงุดุชู ุจุงุดุฏ. ูฺ interface ุง ฺฉูุงุณ ูพุงูโ ูุดุชุฑฺฉ ุจุฑุง ููู ุงู ููุงุฑุฏ ูุฌูุฏ ูุฏุงุฑุฏ (ุงูุจุชู `OnCompleted` ุจุฎุด ุงุฒ ุงูุชุฑูุณ `INotifyCompletion` ุงุณุช).

๐ ุงฺฏุฑ Task ูุงุฏุฑ fault ุดูุฏุ ุงุณุชุซูุง ุฒูุงู ฺฉู continuation ูุฑุงุฎูุงู `GetResult()` ุฑุง ุงูุฌุงู ูโุฏูุฏ ุฏูุจุงุฑู ูพุฑุชุงุจ ูโุดูุฏ.
ุจุฑุชุฑ `GetResult` ูุณุจุช ุจู ุฏุณุชุฑุณ ูุณุชูู ุจู `Result` ุงู ุงุณุช ฺฉู ุงุณุชุซูุงูุง ุฑุง ุจุฏูู ุจุณุชูโุจูุฏ ุฏุฑ `AggregateException` ูพุฑุชุงุจ ูโฺฉูุฏุ ฺฉู ุจุงุนุซ ฺฉุฏูุง `catch` ุชูุฒุชุฑ ูโุดูุฏ.

---

### ูฺฉุชู ุฏุฑุจุงุฑูโ Synchronization Context ๐๏ธ

ุงฺฏุฑ ฺฉ **SynchronizationContext** ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏุ `OnCompleted` ุขู ุฑุง ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ capture ูโฺฉูุฏ ู continuation ุฑุง ุฏุฑ ููุงู context ุงุฌุฑุง ูโฺฉูุฏ. ุงู ุจุฑุง ุงูพูฺฉุดูโูุง ุฑุงุจุท ฺฉุงุฑุจุฑ (UI) ุจุณุงุฑ ููุฏ ุงุณุชุ ฺูู Continuation ุจู ูุฎ UI ุจุงุฒฺฏุฑุฏุงูุฏู ูโุดูุฏ.

ุงูุง ุฏุฑ ฺฉุชุงุจุฎุงููโูุง ูุนูููุงู ูุทููุจ ูุณุชุ ฺูู ุงู ูพุฑุด ุจู ูุฎ UI ูุฒููโุจุฑ ุงุณุช.
ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุขู ูโุชูุงู ุงุฒ ูุชุฏ `ConfigureAwait(false)` ุงุณุชูุงุฏู ฺฉุฑุฏ:

```csharp
var awaiter = primeNumberTask.ConfigureAwait(false).GetAwaiter();
```

ุงฺฏุฑ ูฺ SynchronizationContextุง ูุฌูุฏ ูุฏุงุดุชู ุจุงุดุฏโุง ุดูุง `ConfigureAwait(false)` ุงุณุชูุงุฏู ฺฉูุฏโContinuation ุจูโุทูุฑ ฺฉู ุฑู ฺฉ **pooled thread** ุงุฌุฑุง ูโุดูุฏ.

---

### ุฑูุด ุฏูู: ContinueWith ๐งฉ

ุฑูุด ุฏฺฏุฑ ุงุชุตุงู Continuationุ ูุฑุงุฎูุงู ูุชุฏ `ContinueWith` ุฑู Task ุงุณุช:

```csharp
primeNumberTask.ContinueWith(antecedent =>
{
  int result = antecedent.Result;
  Console.WriteLine(result); // ููุงุด 123
});
```

๐น `ContinueWith` ุฎูุฏุด ฺฉ Task ุจุฑูโฺฏุฑุฏุงูุฏุ ุจูุงุจุฑุงู ูโุชูุงูุฏ ฺูุฏู Continuation ุฒูุฌุฑูโุง ุจุณุงุฒุฏ.
ุงูุง ุฏุฑ ุงู ุญุงูุช ุจุงุฏ ุจูโุตูุฑุช ูุณุชูู ุจุง `AggregateException` ุณุฑูฺฉุงุฑ ุฏุงุดุชู ุจุงุดุฏ ู ุจุฑุง ุงูพูฺฉุดูโูุง UI ฺฉุฏ ุงุถุงู ุจุฑุง **marshal ฺฉุฑุฏู** Continuation ุจููุณุฏ.
ููฺูู ุฏุฑ ูุญุทโูุง ุบุฑ UIุ ุงฺฏุฑ ุจุฎูุงูุฏ Continuation ุฑู ููุงู ูุฎ ุงุฌุฑุง ุดูุฏุ ุจุงุฏ ฺฏุฒููโ `TaskContinuationOptions.ExecuteSynchronously` ุฑุง ูุดุฎุต ฺฉูุฏุ ุฏุฑ ุบุฑ ุงู ุตูุฑุช ุจู thread pool ูพุฑุด ุฎูุงูุฏ ฺฉุฑุฏ.

๐ `ContinueWith` ุจูโูฺู ุฏุฑ ุณูุงุฑููุง **parallel programming** ููุฏ ุงุณุช (ุฏุฑ ูุตู 22 ุจูโุทูุฑ ฺฉุงูู ุจุฑุฑุณ ุฎูุงูุฏ ุดุฏ).

---

### TaskCompletionSource โก

ุชุง ุงูุฌุง ุฏุฏู ฺฉู `Task.Run` ฺฉ Task ูโุณุงุฒุฏ ฺฉู delegate ุฑุง ุฑู ฺฉ ูุฎ (pooled ุง ุบุฑ pooled) ุงุฌุฑุง ูโฺฉูุฏ. ุงูุง ุฑูุด ุฏฺฏุฑ ุงุณุชูุงุฏู ุงุฒ `TaskCompletionSource` ุงุณุช.

`TaskCompletionSource` ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ฺฉ Task ุจุณุงุฒุฏ ฺฉู ุญุงุตู ูุฑ ุนููุงุช ุจุงุดุฏ ฺฉู ุฏุฑ ุขูุฏู ฺฉุงูู ุฎูุงูุฏ ุดุฏ. ุงู ฺฉุงุฑ ุงุฒ ุทุฑู ุณุงุฎุช ฺฉ Task ยซูุงุจุณุชูยป ุงูุฌุงู ูโุดูุฏ ฺฉู ุดูุง ุจูโุทูุฑ ุฏุณุช ฺฉูุชุฑูุด ูโฺฉูุฏ (ุจุง ูุดุฎุต ฺฉุฑุฏู ุฒูุงู ูพุงุงู ุง fault ุดุฏู ุนููุงุช).

ุงู ุฑูุด ุจุฑุง ุนููุงุชโูุง I/O-bound ุนุงู ุงุณุช: ุดูุง ููู ูุฒุงุง Taskูุง (ุงูุชูุงู ููุงุฏุฑ ุจุงุฒฺฏุดุชุ ุงุณุชุซูุงูุง ู Continuationูุง) ุฑุง ุฏุงุฑุฏุ ุจุฏูู ุงูฺฉู ฺฉ ูุฎ ุจุฑุง ฺฉู ูุฏุช ุงุดุบุงู ุดูุฏ.

ุจุฑุง ุงุณุชูุงุฏูุ ฺฉุงูุณุช ฺฉ ููููู ุงุฒ ฺฉูุงุณ ุจุณุงุฒุฏ. ุงู ฺฉูุงุณ ฺฉ ูฺฺฏ ุจู ูุงู `Task` ุฏุงุฑุฏ ฺฉู ููุงู Task ุงุณุช ฺฉู ูโุชูุงูุฏ ุฑู ุขู ููุชุธุฑ ุจูุงูุฏ ุง Continuation ูุตู ฺฉูุฏ. ฺฉูุชุฑู ฺฉุงูู Task ูู ุจุง ุฎูุฏ `TaskCompletionSource` ุงุณุช ุงุฒ ุทุฑู ูุชุฏูุง ุฒุฑ:

```csharp
public class TaskCompletionSource<TResult>
{
  public void SetResult (TResult result);
  public void SetException (Exception exception);
  public void SetCanceled();
  public bool TrySetResult (TResult result);
  public bool TrySetException (Exception exception);
  public bool TrySetCanceled();
  public bool TrySetCanceled (CancellationToken cancellationToken);
  ...
}
```

ูุฑุงุฎูุงู ูุฑฺฉุฏุงู ุงุฒ ุงู ูุชุฏูุง Task ุฑุง ุณฺฏูุงู ูโุฏูุฏ ู ุขู ุฑุง ุฏุฑ ูุถุนุช **completed**ุ **faulted** ุง **canceled** ูุฑุงุฑ ูโุฏูุฏ.

๐ ุงูุชุธุงุฑ ุงู ุงุณุช ฺฉู ุฏููุงู ฺฉ ุงุฒ ุงู ูุชุฏูุง ฺฉโุจุงุฑ ูุฑุงุฎูุงู ุดูุฏ. ุงฺฏุฑ ุฏูุจุงุฑู `SetResult`, `SetException` ุง `SetCanceled` ุตุฏุง ุฒุฏู ุดููุฏุ ุงุณุชุซูุง ูพุฑุชุงุจ ูโฺฉููุฏ. ุฏุฑุญุงูโฺฉู ูุชุฏูุง `Try*` ููุท ููุฏุงุฑ `false` ุจุฑูโฺฏุฑุฏุงููุฏ.

---

### ููููู ฺฉุฏ: ฺุงูพ ุนุฏุฏ ดฒ ุจุนุฏ ุงุฒ ต ุซุงูู ๐

```csharp
var tcs = new TaskCompletionSource<int>();
new Thread(() => { Thread.Sleep(5000); tcs.SetResult(42); })
{ IsBackground = true }
.Start();
Task<int> task = tcs.Task;         
Console.WriteLine(task.Result);   // 42
```

---

### ููุดุชู ูุชุฏ Run ุงุฎุชุตุงุต ๐

```csharp
Task<TResult> Run<TResult>(Func<TResult> function)
{
  var tcs = new TaskCompletionSource<TResult>();
  new Thread(() =>
  {
    try { tcs.SetResult(function()); }
    catch (Exception ex) { tcs.SetException(ex); }
  }).Start();
  return tcs.Task;
}
...
Task<int> task = Run(() => { Thread.Sleep(5000); return 42; });
```

ุงู ฺฉุงุฑ ูุนุงุฏู ูุฑุงุฎูุงู `Task.Factory.StartNew` ุจุง ฺฏุฒููโ `TaskCreationOptions.LongRunning` ุงุณุช.

---

### ูุฏุฑุช ุงุตู TaskCompletionSource โก

ูุฏุฑุช ูุงูุน ุงู ุฑูุด ุฏุฑ ุณุงุฎุช Taskูุง ุงุณุช ฺฉู **ูุฎ ุฑุง ุงุดุบุงู ููโฺฉููุฏ**. ุจุฑุง ูุซุงู:
ูโุฎูุงูู Task ุจุณุงุฒู ฺฉู ุจุนุฏ ุงุฒ ต ุซุงูู ููุฏุงุฑ ดฒ ุฑุง ุจุฑฺฏุฑุฏุงูุฏ. ูโุชูุงูู ุจุฏูู ุงุณุชูุงุฏู ุงุฒ Thread ู ููุท ุจุง ุงุณุชูุงุฏู ุงุฒ `Timer` ุงู ฺฉุงุฑ ุฑุง ุงูุฌุงู ุฏูู:

```csharp
Task<int> GetAnswerToLife()
{
  var tcs = new TaskCompletionSource<int>();
  var timer = new System.Timers.Timer(5000) { AutoReset = false };
  timer.Elapsed += delegate { timer.Dispose(); tcs.SetResult(42); };
  timer.Start();
  return tcs.Task;
}
```

ุจุง ูุตู ฺฉุฑุฏู ฺฉ Continuation ุจู ุงู Task:

```csharp
var awaiter = GetAnswerToLife().GetAwaiter();
awaiter.OnCompleted(() => Console.WriteLine(awaiter.GetResult()));
```

---

### ุณุงุฎุช ูุชุฏ Delay ุนููู โฑ๏ธ

ูโุชูุงูู ฺฉุฏ ุจููุณู ฺฉู ููุท ุตุจุฑ ฺฉูุฏ (ุจุฏูู ููุฏุงุฑ ุจุงุฒฺฏุดุช):

```csharp
Task Delay(int milliseconds)
{
  var tcs = new TaskCompletionSource<object>();
  var timer = new System.Timers.Timer(milliseconds) { AutoReset = false };
  timer.Elapsed += delegate { timer.Dispose(); tcs.SetResult(null); };
  timer.Start();
  return tcs.Task;
}
```

๐ ุฏุฑ .NET 5 ุจู ุจุนุฏุ ูุณุฎูโ ุบุฑ generic ุงุฒ TaskCompletionSource ูุนุฑู ุดุฏู ุงุณุชุ ุจูุงุจุฑุงู ูโุชูุงูุฏ ุจูโุฌุง `TaskCompletionSource<object>` ุงุฒ ุขู ุงุณุชูุงุฏู ฺฉูุฏ.

---

### ุงุฌุฑุง ฑฐ,ฐฐฐ ุนููุงุช ููุฒูุงู ๐

ุงุฒ ุขูุฌุง ฺฉู ุงู ุฑูุด ูุฎโูุง ุฑุง ุงุดุบุงู ููโฺฉูุฏุ ูโุชูุงูู ูุฒุงุฑุงู ุนููุงุช ุฑุง ููุฒูุงู ุงุฌุฑุง ฺฉูู:

```csharp
for (int i = 0; i < 10000; i++)
  Delay(5000).GetAwaiter().OnCompleted(() => Console.WriteLine(42));
```

ุชุงูุฑูุง callbackูุง ุฎูุฏ ุฑุง ุฑู **pooled threads** ุงุฌุฑุง ูโฺฉููุฏ. ุจูุงุจุฑุงู ุจุนุฏ ุงุฒ ต ุซุงููุ thread pool ุฏุฑุฎูุงุณุชโูุง ุฒุงุฏ ุจุฑุง `SetResult(null)` ุฏุฑุงูุช ูโฺฉูุฏ. ุงฺฏุฑ ุฏุฑุฎูุงุณุชโูุง ุณุฑุนโุชุฑ ุงุฒ ุชูุงู ูพุฑุฏุงุฒุด ุจุฑุณูุฏุ thread pool ุขูโูุง ุฑุง ุฏุฑ ุตู ูุฑุงุฑ ูโุฏูุฏ ู ุฏุฑ ุณุทุญ ุจูููโ ููุงุฒโุณุงุฒ ูพุฑุฏุงุฒุด ูโฺฉูุฏ.

ุงุฒ ุขูุฌุง ฺฉู ฺฉุงุฑ ูุฎโูุง ฺฉูุชุงู ุงุณุช (ููุท ูุฑุงุฎูุงู `SetResult` ู ุงุฌุฑุง continuation)ุ ุงู ุฑูุด ุจุณุงุฑ ุจููู ุนูู ูโฺฉูุฏ.
